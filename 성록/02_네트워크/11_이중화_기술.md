# 11장. 이중화 기술

1) 이중화 기술 개요
2) LACP
3) 서버의 네트워크 이중화 설정 (Windows, Linux)
4) MC-LAG
5) 게이트웨이 이중화

> 💡
> - 

---
<br/>

## 1️⃣ 이중화 기술 개요

### ❇️ SPoF (Single Point of Failure)

> 단일 장애점(SPoF)은 **시스템 구성 요소 중 동작하지 않으면 전체 시스템이 중단되는 요소**를 말합니다. 
> 예를 들어 이더넷 케이블과 전원, 이더넷 허브, 접속 단말들의 NIC 등으로 이루어진 간단한 이더넷 네트워크 시스템에서 네트워크 허브 장치의 전원은 SPoF입니다.
> 허브의 전원이 차단됨과 동시에 나머지 모든 요소는 네트워크를 사용할 수 없습니다. 
> 고가용성을 추구하는 네트워크, 소프트웨어 애플리케이션, 상용 시스템에 단일 장애점이 있는 것은 바람직하지 않습니다.
> 단일 고장점 또는 단일 실패점이라고도 합니다.
> (출처: 위키백과-SPoF)

- SPoF(단일 장애점)는 시스템 구성 요소 중 어느 하나가 동작하지 않을 때 시스템 전체가 중단되게 하는 요소를 말한다
- 서비스를 제공할 때 인프라의 주된 목표는 가용성, 연속석, 안정성이다
- 따라서, 인프라를 설계할 때 서비스를 안정적으로 운영하기 위해 SPoF 문제를 발생시키지 않는 방향으로 설계하는 것이 중요하다

### ❇️ 이중화의 목적

- 이중화 기술은 인프라를 구성하는 각 요소가 복수 개 이상으로 인프라를 구성하여, 어느 한 곳에 문제가 발생하더라도 아중화된 다른 요소를 통해 서비스가 지속될 수 있도록 하는 것이다
- 안정적인 서비스 제공을 위해서 이중화 기술은 서비스 운영에 필수적인 기술이다
- 서비스에 필요한 출발 지점부터 끝 지점까지(End-to-End) 속하는 모든 인프라에 이중화 구성을 고려해야 한다
- 서비스를 위한 물리적 또는 가상 머신 서버, 서버와 네트워크 장비를 구성해주는 인터페이스, 서버에 연결된 스위치, 다수 서버의 부하 분산을 위한 L4/L7 스위치, 방화벽, 인터넷 게이트웨이, 인터넷 회선 등 인프라의 모든 요소가 이중화 구성이 필요한 항목들이 될 수 있다
- 심지어 이 모든 요소가 속한 데이터 센터 자체도 이중화를 하기도 하며, 이를 DR 센터(Disaster Recovery Center, 재해복구센터)나 액티브-액티브 데이터 센터로 구축한다

#### 액티브-액티브, 액티브-스탠바이

- 액티브-액티브 이중화 구성은 각 구성 요소들이 모두 동시에 운영 중인 상태로 동작하며 서비스를 운영하는 것이다
- 액티브-스탠바이 구성은 하나의 구성 요소는 운영 상태이고 다른 하나는 대기 상태로 있다가, 운영 상태인 요소에서 장애 발생 시 대기 상태에 있던 요소가 운영 상태로 전환되는 방식이다
- 액티브-액티브 구성에서 유의할 점은 장애 발생 시 해당 인프라에서는 트래픽을 수용할 수 없게 되기 때문에 그만큼 전체 인프라 용량이 줄어들게 되므로, 설계 시 이 점을 유의하여 인프라를 설계해야 한다

---
<br/>


## 2️⃣ LACP (Link Aggregation Control Protocol)

- 1990년대 중반까지는 각 벤더별로 장비 간 대역폭을 늘리기 위해 독자적인 방법으로 구현해왔지만, 이는 다른 장비끼리 연결할 때 호환성 문제가 발생하게 되었다
- 이 문제를 해결하기 위해 1997년 11월, IEEE 802.3 그룹이 상호호환이 가능한 연결 계층(Link Layer) 표준화를 시작하였으며, 이 표준화가 LACP이다
- 2000년에 802.3ad로 초기 출시되었고, 2008년에 IEEE 802.1AX-2008로 옮겨졌다
- 링크 애그리게이션의 목적은 대역폭 확장을 통한 다음의 두 가지를 제공하는 것이다 (IEEE 802.1AX-2008)
  - 링크 사용률 향상 (Improved Utilization of Available Link)
  - 향상된 장애 회복 (Improved Resilience)


- LACP를 사용하면 두 개 이상의 물리 인터페이스로 구성된 논리 인터페이스를 이용해 모든 물리 인터페이스를 액티브 상태로 사용한다
- 이를 통해 스위치와 스위치 또는 스위치와 서버 간 네트워크 대역폭이 물리 인터페이스 수량만큼 확장된다
- 또한, 논리 인터페이스를 구성하는 물리 인터페이스 중 일부에서 문제가 발생하더라도 나머지 물리 인터페이스로 서비스를 유지해준다
- LACP는 액티브-액티브 방식으로 구성된다

### ❇️ LACP 구성시 유의사항

- LACP는 액티브-액티브 구조이므로 장애 발생 시 줄어들게 되는 대역폭을 고려하여 산정해야 한다
- LACP로 구성하는 물리 인터페이스들의 속도가 동일해야 한다

### ❇️ LACP 동작 방식

- LACP를 통해 장비 간 논리 인터페이스를 구성하기 위해 LACPDU(LACP Data Unit)라는 프레임을 사용한다
- LACPDU에는 LACP를 구성하기 위한 출발지 주소, 목적지 주소, 타입, 서브 타입, 버전 정보 등을 포함해 매초마다 주고받는다
- LACPDU는 멀티캐스트를 이용하고, LACPDU의 목적지 주소는 "01:80:c2:00:00:02"부터 "01:80:c2:00:00:10"까지 사용한다
- LACP가 연결되려면 LACPDU를 주고받는 장비가 한 장비여야 한다. 즉, LACP를 구성하는 두 개 이상의 물리 인터페이스가 서로 다른 장비에 연결되어 있으면 LACP를 통한 링크 이중화 구성을 할 수 없다 (장비 간 1:1 구성만 가능)

#### LACP 모드

- 액티브: LACPDU를 먼저 송신하고 상대방이 LACP로 구성된 경우, LACP를 구성
- 패시브: LACPDU를 송신하지 않지만 LACPDU를 수신받으면 응답해 LACP를 구성

보통 액티브 옵션을 사용하므로 LACPDU를 상대방 장비에 보내거나 받는다.  
패시브 옵션인 경우에는 LACPDU를 먼저 보내지 않지만 상대방이 보내온 LACPDU에 대한 응답을 통해 LACP가 구성된다.  
즉, LACP를 구성한 모든 장비에서 LACPDU를 보내는 것은 아니지만 LACPDU를 받기를 기다리고 있고 단방향이라도 LACPDU를 받아 정상적인 LACPDU를 교환하면 LACP가 구성된다.  
다만, 양 단 장비 모두 패시브로 설정하면 LACPDU를 아무도 먼저 보내지 않으므로 정상적인 LACP 연결이 되지 않는다.
LACP로 구성될 수 있는 인터페이스 수는 장비에 따라 조금씩 다르지만 일반적으로 1~8개로 구성된다.  
LACP 논리 인터페이스를 구성하는 물리 인터페이스들은 반드시 동일한 속도의 인터페이스로 구성해야 한다.(1G 두 개, 10G 두 개 가능. 1G와 10G는 불가능)

### ❇️ LACP와 PXE(Pre-boot eXecution Environment)

- PXE를 이용할 때는 서버가 운영체제를 설치하기 전 단계이므로 본딩과 티밍 같은 논리 인터페이스를 설정할 수 없다 (LACP를 사용할 수 없다)  
  _(LACP 설정은 본딩과 티밍에서 액티브-액티브로 사용하기 위한 옵션 설정으로 뒤에서 다룬다)_
- 따라서 LACP로 구성하려는 서버를 PXE로 운영체제를 설치할 때는 LACP 인터페이스가 아닌 일반 인터페이스로 구성해 운영체제를 설치하고, 운영체제에서 LACP 설정을 다시 한 후 스위치 포트 설정을 다시 변경해야 한다

---
<br/>


## 3️⃣ 서버의 네트워크 이중화 설정 (Windows, Linux)

생략...

---
<br/>

## 4️⃣ MC-LAG (Multi-Chassis Link Aggregation Group)

- LACP를 구성할 때는 LACPDU를 주고 받는 장비 상호 간 구성이 1:1이어야 한다. 더 명확히는 MAC 주소가 1:1이어야 한다.
- 그래서 서버에서 본딩이나 티밍과 같은 이중화 구성을 할 때, 각 네트워크 카드별로 물리 MAC 주소를 따로 사용하지 않고, 두 개의 물리 MAC 주소 중 하나를 Primary MAC 주소로 사용한다.
- 즉, 여러 개의 물리 인터페이스를 쓰더라도 하나의 MAC 주소를 사용해 이 조건을 만족한다
- 그런데 위 방식은 SPoF 문제가 발생할 수 있다.

- MC-LAG 기술을 이용하면 단일 스위치로 LACP를 구성해 대욕폭을 확장할 것인지, 서로 다른 스위치로 구성해 장비 이중화로 가용성을 확보할 것인지를 선택할 수 있다
- MC-LAG은 실제 네트워크 벤더에 따라 기술명이 조금씩 다르다
  - 시스코 시스템즈사의 넥서스 시리즈에서는 vPC(Virtual Port Channel), 아리스타나 익스트림 네트웍스에서는 MLAG 등

### ❇️ MC-LAG 동작 방식

#### MC-LAG의 구성 요소

- 피어(Peer) 장비
  - MC-LAG을 구성하는 장비를 피어 장비라고 한다
- MC-LAG 도메인(Domain)
  - 두 Peer 장비를 하나의 논리 장비로 구성하기 위한 영역 ID이다. Peer 장비는 이 영역 ID를 통해 상대방 장비가 Peer를 맺으려는 장비인지 판단한다
- 피어 링크(Peer-Link)
  - MC-LAG을 구성하는 두 Peer 장비 간의 데이터 트래픽을 전송하는 인터링크이다

MC-LAG을 구성하려면 피어들을 하나의 도메인으로 구성해야 한다.  
각 피어에는 동일한 도메인 ID 값을 설정한다.  
피어는 피어 간 데이터 트래픽을 전송하기 위한 피어 링크를 구성한다.  
피어 링크는 다양한 네트워크 통신할 수 있는 경로이므로 보통 트렁크(Trunk)로 구성한다.


## 5️⃣ 게이트웨이 이중화

### ❇️ 게이트웨이 이중화란?

- 특정 호스트가 동일한 서브넷에 있는 내부 네트워크와 통신할 때는 ARP(Address Resolution Protocol)를 직접 브로드캐스트해 출발지와 목적지가 직접 통신한다
- 목적지가 출발지 호스트의 서브넷에 포함되지 않은 외부 네트워크인 경우, 목적지와 통신하기 위해 게이트웨이를 통해야 하며 이를 L3 통신이라고 한다
- 그런데 게이트웨이 장비에 장애가 발생하면, 해당 게이트웨이를 바라보는 하단의 호스트들은 게이트웨이와 통신할 수 없으므로 외부 네트워크와 통신할 수 없게 된다
- 이런 경우에 사용하는 프로토콜이 FHRP(First Hop Redundancy Protocol)라는 게이트웨이 이중화 프로토콜이다
- FHRP를 사용하면 두 라우터는 실제 IP 외에 추가로 가상 IP 주소와 가상 IP에 대한 MAC 주소를 동일하게 갖는다
- FHRP의 가상 IP는 그룹 내에서 우선순위가 높은 장비가 Active 상태로 유지하고 ARP 요청에 응답한다
- 하단 호스트들이 사용할 게이트웨이 IP 주소가 이 가상 IP 주소이다
- FRHP 장비 중 가상 IP에 대한 Active 상태를 가진 장비에 문제가 발생하면 Standby 상태인 장비가 Active 상태로 변경된다

### ❇️ FHRP (First Hop Redundancy Protocol)

- FHRP는 외부 네트워크와 통신하기 위해 사용되는 게이트웨이 장비를 두 대 이상의 장비로 구성할 수 있는 프로토콜이다
- FHRP를 이용해 FHRP 그룹 내의 장비가 동일한 가상 IP를 갖도록 설정하고, FHRP를 설정할 때는 우선순위 값을 이용해 어떤 장비가 가상 IP 주소에 대한 Active 역할을 할 것인지 결정한다
- FHRP 그룹의 장비는 물리적으로 다른 장비이지만 가상 IP와 가상 IP MAC 주소도 동일하다
- FHRP 그룹의 액티브 장비에 장애가 발생하면 스탠바이 장비는 액티브 장비가 비정상임을 확인한 후 가상 IP 주소에 대한 액티브 역할을 가져온다.
- 또한, 가상 IP 주소의 MAC 주소에 대한 MAC 주소 테이블을 갱신해 하단 호스트들은 아무 설정 변경 없이 절체가 이루어진다

#### VRRP (Virtual Router Redundancy Protocol)

- FHRP 기술에 대한 표준 프로토콜은 VRRP이다
- VRRP는 표준 프로토콜이므로 게이트웨이 이중화 기술로서 거의 모든 벤더 장비가 VRRP 기능을 지원한다
- VRRP 외에도 각 벤더에서 자체 게이트웨이 이중화 기술을 구현하기도 하는데, 가장 많이 알려진 벤더 자체 개발 게이트웨이 이중화 기술은 시스코 시스템즈사의 HSRP(Hot Standby Router Protocol)이다.

### ❇️ 올 액티브 게이트웨이 이중화

- FHRP는 게이트웨이로 사용되는 가상 IP 주소는 이중화된 장비에서 액티브-스탠바이로 동작한다
- 사용자가 가상 IP 주소(게이트웨이 주소)에 대해 ARP 요청을 하면 액티브 장비에서 응답하고 스탠바이 장비에서는 가상 IP에 대한 MAC 주소 테이블을 액티브 장비와 연결된 인터페이스로 학습한다
- 게이트웨이 외부로 가기 위한 경로가 스탠바이더라도 액티브 장비를 통해서만 외부로 나갈 수 있다
- 즉, 피어 장비 모두 게이트웨이 역할을 할 수 있음에도 불구하고 트래픽이 불필요하게 우회하므로 비효율적이다
- 그래서 MC-LAG 기술을 사용할 때는 게이트웨이 이중화 가상 IP의 MAC 주소를 액티브 장비와 스탠바이 장비에서 모두 사용할 수 있도록 해 게이트웨이를 액티브-액티브 형태로 구성하는 기능을 제공한다
- 게이트웨이를 액티브-액티브로 구성하면 액티브 장비로 들어오는 트래픽은 물론 스탠바이 장비로 들어오는 트래픽도 스탠바이 장비에서 직접 처리해 트래픽 흐름을 최적화할 수 있다

### ❇️ 애니캐스트 게이트웨이

- 액티브-액티브 게이트웨이는 네트워크가 한 위치에 존재할 때 게이트웨이를 이중화하는 방식이다
- 오버레이 기반의 SDN 네트워크를 구현하면 같은 네트워크가 여러 위치에 존재하게 되므로 네트워크를 디자인 할 수 있는데 게이트웨이가 한 곳에 위치하게 되면 모든 트래픽이 하나의 게이트웨이를 거쳐 통신하게 되므로 통신이 비효율적으로 이루어지게 된다
- 이런 경우, 애니캐스트 게이트웨이 기술을 적용하면 각 위치에 같은 주소를 가지는 게이트웨이가 여러 개 동작할 수 있다
- 애니캐스트 게이트웨이는 애니캐스트를 사용한다
- 여러 개의 같은 IP를 가지는 게이트웨이가 존재하지만 가장 가까운 위치에 있는 게이트웨이에서 서비스를 제공한다
- 게이트웨이가 여러 곳에 위치하므로 하나의 게이트웨이에 문제가 발생해도 렉 하나에서만 장애가 발생하고 다른 위치에서는 외부로 통신하는데 문제가 없다

