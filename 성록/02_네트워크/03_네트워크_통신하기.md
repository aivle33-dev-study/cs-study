# 3장. 네트워크 통신하기

1) 유니캐스트, 멀티캐스트, 브로드캐스트, 애니캐스트
2) MAC 주소
3) IP 주소
4) TCP와 UDP
5) ARP
6) 서브넷과 게이트웨이

---
<br/>

## 1️⃣ 유니캐스트, 멀티캐스트, 브로드캐스트, 애니캐스트
   
네트워크에서 출발지 → 목적지로 데이터를 전송할 때 사용하는 통신 방식은 다음과 같다.

### 🔶 유니캐스트

- 1:1 통신
- 출발지와 목적지가 1:1로 통신
- 대부분의 통신은 유니캐스트 방식을 사용한다.

### 🔶 브로드캐스트

- 1:모든 통신
- 동일 네트워크에 존재하는 모든 호스트가 목적지
- 유니캐스트로 통신하기 전, 주로 상대방의 정확한 위치를 알기 위해 사용된다.
- 기본 동작은 로컬 네트워크 내에서 모든 호스트에 패킷을 전달해야 할 때 사용된다.

### 🔶 멀티캐스트

- 1:그룹(멀티캐스트 구독 호스트) 통신
- 하나의 출발지에서 다수의 특정 목적지로 데이터 전송
- IPTV와 같은 실시간 방송을 볼 때 이 멀티캐스트 통신 방식을 사용한다.
- 사내방송, 증권 시세 전송과 같이 단방향으로 다수에게 동시에 같은 내용을 전달해야 할 때 사용된다.

### 🔶 애니캐스트

- 1:1 통신 (목적지는 동일 그룹 내의 1개 호스트)
- 다수의 동일 그룹 중 가장 가까운 호스트에서 응답
- IPv4에서는 일부 기능 구현, IPv6은 모두 구현 가능
- 애니캐스트 게이트웨이의 성질을 이용해 가장 가까운 DNS서버를 찾을 떄 사용한다.
- 가장 가까운 게이트웨이를 찾는 애니캐스트 게이트웨이 기능에 사용한다.
- 최종 통신은 1:1로 유니캐스트와 동일하지만 통신 대상 후보자는 서로 다르다.
  - 유니캐스트는 출발지와 목적지가 모두 한 대씩이다.
  - 애니캐스트는 같은 목적지 주소를 가진 서버가 여러대여서 통신 가능한 다수의 후보군이 있다.

### 정리
- 현재 주로 사용되는 네트워크 주소체계는 IPv4 기반이다.  
  (일부 모바일 네트워크 및 대규모 데이터 센트 위주로 IPv6 기반이 사용되고 있다.)
- IPv6에서는 브로드캐스트가 존재하지 않고 링크 로컬 멀티캐스트로 대체되어 사용된다.
- 통신 방식을 구분할 때 핵심은 실제 데이터를 전달하려는 출발지가 기준이 아니라 목적지 주소를 기준으로 구분한다는 점이다.


> #### 💡 참고: BUM 트래픽
> B(Broadcast), U(Unknown Unicast), M(Multicast)를 지칭하는 단어로 서로 다른 종류의 트래픽이지만 네트워크에서 동작은 비슷하다.  
> BUM 트래픽에 대한 이해가 중요한 이유는 유니캐스트지만 실제 겉으로 보이는 동작 방식은 브로드캐스트에 가깝기 때문이다.  
> (유니캐스트이기에 전달받는 모든 단말 NIC에서는 도착지 주소 확인 후 자신이 목적지가 아닐경우 패킷을 버린다)  
> Unknown Unicast: 목적지 주소는 명시되어 있지만 네트워크에서의 동작은 브로드캐스트와 같을 때를 가리킨다.  
> 유니캐스트이기에 목적지는 명시되어있지만, 스위치가 목적지에 대한 주소를 학습하지 못한 상황(이런 상황을 스위치 입장에선 Unknown이라 한다.) 이기에 패킷을 모든 포트로 플러딩(전송)하는데 이런 유니캐스트를 Unknown Unicast라 한다.  
> 네트워크 입장에서 네트워크 자원이 불필요하게 사용되기에 불필요한 BUM 트래픽이 많아질수록 네트워크 성능은 저하될 수 있다.  
> 이더넷 환경에서는 ARP브로드캐스트를 먼저 보낸 뒤 통신을 시작하기에 BUM 트래픽이 많이 발생하지 않는다.

---
<br/>

## 2️⃣ MAC 주소

MAC(Media Access Control)은 2계층(데이터 링크 계층)에서 통신을 위해 네트워크 인터페이스에 할당된 고유 식별자다. 이 MAC 주소는 이더넷과 와이파이를 포함한 대부분의 IEEE 802 네트워크 기술에서 2계층 주소로 사용되며 네트워크에 접속하는 모든 장비는 이러한 MAC주소가 있어야 하며 이 주소로 서로 통신하게 된다.

### 🔶 MAC 주소 체계

- 주소를 변경할수 없도록 하드웨어에 고정되어 있다.
- 제조업체마다 하나 이상의 주소풀을 주고 각 제조업체는 이 주소풀 안에서 자체적으로 MAC 주소를 할당한다.
- 네트워크 장비 제조업체에서 주소풀을 할당하는 것을 제조사 코드(Vender Code)라 하며 국제기구인 IEEE에서 관리한다.
- 48비트의 16진수 12자리로 표현되며, 앞의 24비트와 뒤의 24비트로 나눠 구분한다.
  - 앞의 24비트가 IEEE가 제조사에 할당하는 제조사 코드이다.
  - 뒤의 24비트는 각 제조사에서 자체적으로 할당하는 부분이다.
- 네트워크 카드(혹은 장비)를 생산할 때 하드웨어적으로 정해져 나오기에 MAC주소를 BIA(Burned-In Address)라고도 부른다.

### 🔶 MAC 주소 동작

- NIC(Network Interface Card)는 MAC주소를 가지고 있다.
- NIC는 전기 신호가 들어오면 2계층에서 데이터 형태(패킷)로 변환하여 내용을 구분한 뒤 도착지 MAC주소를 확인한다.
  - 만약 도착지 MAC주소가 자신이 갖고있는 MAC주소와 다를경우 패킷을 폐기한다.
  - MAC주소가 같거나 브로드캐스트, 멀티캐스트와 같은 그룹주소일 경우 처리해야 할 주소로 인지해 패킷 정보를 상위 계층으로 넘겨준다.
  - NIC는 목적지 MAC주소가 자신을 목적지로 한 패킷만 수용한다.
- 본인의 주소, 브로드캐스트 주소는 NIC가 자체적으로 패킷을 처리하는게 아니라 OS나 애플리케이션에서 처리해야 하기 때문에 시스템 부하가 작용한다.
- 브로드캐스트 스톰의 경우 브로드캐스트가 회선을 모두 채우게 되는데 네트워크에 연결된 모든 단말이 브로드 캐스트를 처리하느라 CPU사용량이 증가한다.  
  (브로드캐스트 스톰은 4장 의 3.1 루프란?에서 나오는 내용)

> #### 💡 참고: 무차별 모드(Promiscuous Mode)
> NIC는 불필요한 패킷(자신의 MAC주소와 일치하지 않는 도착지 주소를 가진 패킷)을 폐기하기 때문에 디버그및 분석 용도나 모니터용도로 전체 패킷을 수집해야 할 경우 NIC가 정상동작을 하면 다른 목적지를 가진 패킷을 분석할 수 없다.  
> 만일 다른 목적지를 가진 패킷도 분석및 수집이 필요하다면 무차별 모드로 NIC를 구성하면 된다.  
> 무차별 모드는 자신의 MAC 주소와 상관없는 패킷이 들어와도 이를 분석할 수 있도록 메모리에 올려 처리할 수 있도록 한다.  
> 이런 무차별 모드를 사용하는 가장 대표적인 사례로는 와이어샤크(Wireshark)가 있다.

---
<br/>

## 3️⃣ IP 주소

OSI 7계층에서 주소를 갖는 계층은 물리적 주소인 MAC주소를 갖는 2계층과 IP주소를 사용하는 3계층이 있다. 대부분의 네트워크는 TCP/IP로 동작하기 때문에 IP주소 체계를 이해하는것은 중요하다.

- **특징**
  - 사용자가 변경 가능한 논리 주소이다.
  - 주소에 레벨이 있으며 그룹을 의미하는 네트워크 주소와 호스트 주소로 나뉜다.

### 🔶 IP 주소 체계

- IP 주소는 우리가 흔히 아는 IPv4(32비트)와 IPv6(128비트)가 있다.
- 각각 8-bit 크기의 4개 영역으로 나뉘는데 하나의 구분을 옥텟(Octet)이라 부른다.
- 이 옥텟은 dot(.) 으로 구분하며 10진수로 표기하기에 8-bit 옥텟은 0~255 값을 쓸 수 있다.

#### 특징

- 네트워크 주소와 호스트 주소 두 부분으로 나뉜다.
  - 네트워크 주소: 호스트들을 모은 네트워크를 지칭하는 주소로 해당 주소가 동일한 네트워크를 로컬 네트워크라 한다.
  - 호스트 주소: 하나의 네트워크 내의 존재하는 호스트를 구분하기 위한 주소
- 네트워크 주소와 호스트 주소를 구분하는 경계점이 고정되어 있지 않다.
- 필요한 호스트IP 갯수에 따라 네트워크의 크기를 다르게 할당할 수 있는 클래스 개념을 도입했다.
- 클래스는 옥텟을 구분자로 사용하는데 이 구분자를 서브넷 마스크라 한다.
- 현재는 이런 클래스 기반을 잘 사용하지 않는다.
  - 더 세밀하게 분할및 할당하기위해 필요 네트워크 크기에 맞춰 1비트 단위로 네트워크를 상세히 분할하는 방법을 사용한다.

### 🔶 클래스풀과 클래스리스

클래스 기반의 IP주소 체계를 클래스풀(Classful)이라 하는데, IP주소 체계 등장 초기에는 확장성과 비용절약등 좋은 방법이였다.  
이 주소 체계에서는 네트워크 주소와 호스트 주소를 구분짓는 서브넷 마스크도 필요없었다. 맨 앞자리 숫자만봐도 클래스 구분이 가능했기에 주소 구분자를 사용할 수 있었다.

#### 클래스리스 네트워크의 등장

시간이 지남에 따라 클래스풀 기반 주소 체계로도 감당이 힘든 시기가 왔다. 이론적으로 IPv4에서사용가능한 IP의 개수는 대략 43억개지만 실제 사용가능한 IP 갯수는 훨씬 적을 것이고 그 숫자는 인구가 하나씩 가질수도 없는 숫자이다.
그래서 이런 문제를 해결하기 위해 3가지 보존, 전환 전략을 만들었는데 다음과 같다.

- **클래스 리스, CIDR(Classless Inter-Domain Routing)기반의 주소체계**
  - IPv4에서 주소 자체가 부족하다는 문제도 있지만, 그 외에도 상위 클래스(A Class)를 할당받은 조직에서 대부분 제대로 사용을 못하고 낭비되는 것도 문제다. 수천만 개의 IP를 사용할 수 있는 A클래스 를 할당받아도 그중 많아야 수만개 정도에서 끝나면 나머지는 다 낭비되며 다른 조직이나 기관에서 사용할수도 없다.
  - 이러한 문제를 해결하기 위해 클래스라는 개념을 버리게되고 이를 클래스리스라 부른다.
  - 현재 우리가 사용하는 주소 체계는 클래스 개념을 적용하지 않는 클래스리스 기반 주소체계이다.
  - 클래스 리스 네트워크에서는 별도로 네트워크와 호스트 주소를 나누는 구분자가 필요한데 이를 서브넷 마스크(Subnet Mask)라 부른다.
  - 이러한 서브넷 마스크는 IP주소와 네트워크 주소를 구분할 때 사용하며 다음과 같이 표시한다.
    - 2진수 숫자 1: 네트워크 주소
    - 2진수 숫자 0: 호스트 주소
  - 이를 10진수로 사용하면 255.0.0.0, 255.255.0.0, 255.255.255.0와 같이 표현할 수 있다.
  - 이해를 돕기위해 103.9.32.146이라는 가상의 주소로 예시를 들면 해당 주소가 255.255.255.0 서브넷 마스크를 사용하는 IP라면 서브넷 마스크와 곱연산을 통해 네트워크 주소와 호스트 주소를 알아낼 수 있다.

### 🔶 서브네팅

서브네팅은 부여된 클래스 기준을 무시한채로 새로운 네트워크-호스트 구분 기준을 사용자가 정해 원래 클래스풀 단위의 네트워크보다 더 쪼개 사용하는 것을 말한다.  
이처럼 부여된 주소를 다시 잘라 사용하는 것을 서브네팅이라 하며 현대 클래스리스 네트워크의 가장 큰 특징이기도 하다.  
서브네팅은 옥텟(Octet)이 아닌 2진수 자리 단위로 서브네팅을 한다.  

- 네트워크 사용자 입장
  - 네트워크에서 사용할 수 있는 IP범위 파악
  - 기본 게이트웨이와 서브넷 마스크 설정이 제대로 되있는지 확인
- 네트워크 설계자 입장
  - 네트워크 설계 시 네트워크 내에 필요한 단말을 고려한 네트워크 범위 설계
  - 사용자와 반대로 서브넷 마스크가 지정되어 주어지는 것이 아닌 네트워크의 크기를 고민해 서브넷 마스크를 결정하고 설계에 반영해야 한다.
  - 설계자가 IP설계시 고려해야 할 부분은 다음과 같다.
    - 서브넷된 하나의 네트워크에 IP를 몇 개나 할당해야 하는가?(or PC는 몇 대나 있는가)
    - 서브넷된 네트워크가 몇 개나 필요한가?


### 🔶 공인 IP와 사설 IP

- 공인아이피: 전 세계에서 유일해야 하는 식별자.
- 사설아이피: 개인적으로 구성되어 IP주소를 할당받지 않고 구축되어 사용되는 식별자

실제 인터넷에 접속하기 위해서는 공인 IP주소가 필요하다.  
하지만, 공인 IP는 통신사업자로부터 할당받거나 IP할당기관에서 인터넷 독립기관 주소를 할당받은 후 독립 IP를 할당받아야 하기에 그 과정이 쉽지 않다.

그래서 인터넷에 접속하지 않거나 NAT(Network Address Translation, 네트워크 주소 변환)기술을 사용한다면 사설 IP주소를 사용할 수 있다.  
이러한 사설 IP를 사용하면 인터넷에 직접 접속하진 못하지만 IP를 변환해주는 NAT장비를 통해 공인 IP로 변경한 뒤 인터넷 접속은 가능하다. 그래서 흔히 우리가 가정에서 사용하는 공유기들은 NAT장비 역할을 해준다.

그리고 사설 네트워크 구축시 주의점이 있는데, NAT을 사용해서 인터넷에 접속을 하더라도 다른 사용자에게 할당된 IP를 사설 네트워크 주소로 사용해서는 안된다.  
그 이유는 내부 네트워크의 할당된 IP를 공식으로 사용하는 네트워크로 접속할 수 없기 때문이며 그 때문에 RFC에 명시된 어인터넷 어느 구간에서도 사용되지 않는 사설 IP대역을 사용할것을 추천한다.

(C회사에서 A회사로 접속을 시도할 경우 C회사 서버는 A회사의 서버가 같은 네트워크에 존재한다고 판단해서 A회사 서버인 20.0.0.20과 통신하기위해 브로드캐스트한다. 실제로는 인터넷 구간을 거쳐서 원격지과 통신 시도를 서로 인식해야하지만, 같은 네트워크로 판단하기에 정상적인 통신이 불가능하다)

> #### 💡 참고: Bogon IP
> IP주소 할당 최상위 기구(IANA)가 여러 목적으로 예약해서 공인 IP로 할당하지 않는 주소를 Bogon IP라 한다.

---
<br/>

## 4️⃣ TCP와 UDP

OSI 7계층 중 4계층에서 동작하는 프로토콜의 목적은 목적지 단말 안에서 동작하는 여러 애플리케이션 프로세스 중 통신해야 할 목적지 프로세스를 정확히 찾아가고 패킷 순서가 바뀌지 않도록 잘 조합해 원래 데이터를 만들어내는데 있다.

### 🔶 4계층 프로토콜(TCP, UDP)와 서비스 포트

데이터를 주고받는 인캡슐레이션과 디캡슐레이션 과정에서 각 계층별로 정의하는 헤더가 추가되고 여러 정보들이 들어간다.  

- 각 계층에서정의하는 정보
- 상위 프로토콜 지시자 정보

출발지와 도착지를 구분하지 않아도 되는 2, 3계층과는 다르게 4계층 프로토콜 지시자인 포트번호는 출발지와 목적지를 구분해서 처리해야 한다.  
TCP/IP 프로토콜 스택 4계층인 전송 계층은 TCP와 UDP가 담당을 하는데, 2, 3계층과는 다르게 목적지를 찾아가는게 아닌 애플리케이션에서 사용하는 프로세스를 정확히 찾아가야하고 패킷을 잘 쪼개서 보내고 잘 조립하는 것이다.  
그리고 패킷을 분할/조립하기 위해 TCP 프로토콜에서는 시퀀스 번호와 ACK 번호를 사용한다.  

> #### 💡 참고: Well Known Port
> HTTP TCP 80, HTTPS TCP 443, SMTP TCP 25와 같이 잘 알려진 포트를 Well Known 포트라 한다.
> 이러한 포트는 인터넷 주소 할당기구인 IANA(Internet Assigned Numbers Authority)에 등록되고 1023번 이하의 포트번호를 사용한다.

### 🔶 TCP

TCP는 4계층 프로토콜(TCP, UDP)과 서비스 포트 절에서 다룬 4계층의 특징을 대부분 포함하고 있다.

#### 특징
- 신뢰할 수 있다.
- 신뢰할 수 없는 공용망에서도 정보유실 없는 통신을 보장하기위해 안전한 세션 연결 및 데이터 분할과 패킷 전송여부를 확인하는 기능이 있다.
- 패킷에 번호(Sequence Number)를 부여해서 전송 상태를 확인한다.
- 잘 전송되었는지에 대한 응답(Acknowledge Number)한다.
- 한 번에 어느 크기로 보내야 수신자가 잘 처리할 수 있는지 전송 크기(Window Size)를 고려해 통신한다.
- 네트워크 상태를 크게 고려하지 않고 쉽고 안전하게 네트워크 사용이 가능하다.

#### 패킷 순서, 응답 번호

- 분할된 패킷을 잘 분할하고 수신 측이 잘 조합하도록 패킷에 순서와 응답 번호를 분여한다.
  - 시퀀스 번호: 패킷에 순서를 부여하는 것
  - ACK 번호: 응답 번호를 부여하는 것
- 두 번호(시퀀스, ACK) 를 이용해 패킷의 순서가 바뀌거나 중간에 손실된 패킷을 파악할 수 있다.
- 보내는 측에서 패킷에 번호를 부여하면 받는 측은 이 번호의 순서가 맞는지 확인 후 다음 번호의 패킷을 요청한다. 이 숫자를 ACK 번호라 한다.
- 송신측에서 ACK 번호를 수신받으면 확인 후 다음 패킷에 번호를 부여해 송신한다.

1. 출발지에서 시퀀스 번호를 0으로 보낸다(SEQ=0)
2. 수신측에선 0번 패킷을 잘 받았기에 응답 번호(ACK)에 1을 적어 응답한다.  
   이때 수신측에서는 자신이 처음 보내는 패킷이기에 자신의 패킷에 시퀀스 번호 0을 보여한다.
3. 송신측은 수신측에서 보낸 ACK번호로 받은 1번 ( 1번 패킷)을 시퀀스 번호로 작성하고 ACK번호는 상대방의 0번 시퀀스를 잘 받았다는 의미로 시퀀스 번호를 1로 부여해 다시 송신한다.

#### 윈도 사이즈와 슬라이딩 윈도

- 윈도 사이즈: 한 번에 받을 수 있는 데이터의 크기
- 슬라이딩 윈도: 네트워크 상황에 따라 윈도 사이즈를 조절하는 것