# 6장. 로드 밸런서 / 방화벽: 4계층 장비 (세션 장비)

1) 4계층 장비의 특징
2) 로드 밸런서
3) 방화벽
4) 4계층 장비를 통과할 때의 유의점 (세션 관리)

<br/>
---

> 기존 네트워크 장비는 스위치와 라우터처럼 2, 3계층에서 동작하는 장비를 지칭하는 용어였지만, 현대에는 IP 부족으로 NAT 기술이 등장하고 보안용 방화벽, 프록시와 같은 장비들이 등장하면서 4계층에서 동작하는 네트워크 장비가 많아지게 되었다.  
> 이러한 4계층 장비의 특징으로는 **포트 번호, 시퀀스 번호, ACK 번호**에 대해 이해하는 것이 중요하다.  
> 기존 2, 3계층 장비에서 고려하지 않았던 **통신의 방향성**이나 **순서**와 같은 통신 전반에 대한 관리가 필요하며, 이런 정보를 **세션 테이블**을 통해 관리한다.

## 1️⃣ 4계층 장비의 특징

4계층 장비는 TCP와 같은 **4계층 헤더에 있는 정보**를 이해하고, 이 정보들을 기반으로 동작한다.  
2, 3계층 네트워크 장비와 다른 점은 **세션 관리**이다.  
그래서 4계층 이상에서 동작하는 로드 밸런서, 방화벽과 같은 장비를 '세션 장비'라고 부르기도 한다.

세션 장비는 추가로 고려해야 할 특징이 많은데, 그 중 최우선적으로 고려해야 할 요소는 다음과 같다.

- **세션 테이블**
    - 세션 장비는 세션 테이블 기반으로 운영된다.
    - 세션 정보를 저장, 확인하는 작업 전반에 대한 이해가 필요하다.
    - 세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재하여 이에 대한 고려가 필요하다.
- **Symmetric(대칭) 경로 요구**
    - Inbound와 Outbound 경로가 일치해야 한다
- **정보 변경 (로드 밸런서의 경우)**
    - IP 주소가 변경되며 확장된 L7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경된다.


<br/>
---

## 2️⃣ 로드 밸런서

- 로드 밸런서는 서버나 장비의 부하를 분산하기 위해 사용되는 장비이다
- IP 주소나 4계층 정보, 애플리케이션 정보를 확인, 수정하는 기능이 있다
- 가장 많이 쓰이는 분야는 웹 서버의 부하 분산이다
- 작은 시스템 여러 대를 운영하더라도 사용자는 서버 배치와 상관없이 하나의 서비스로 보여야 한다.  
  로드 밸런서가 서비스에 사용되는 대표 IP 주소를 서비스 IP로 갖고, 그 밑에 시스팀이 늘어나면 로드 밸런서가 각 시스템의 실제 IP로 변경해 요청을 보낸다.
- 이러한 로드 밸런서는 웹 애플리케이션 뿐만 아니라 FWLB(FireWall Load Balancing: 방화벽 로드 밸런싱), VPNLB(VPN Load Balancing: VPN 로드 밸런싱)와 같이 다양한 서비스를 위해 사용될 수 있다.

로드 밸런서는 동작하는 계층에 따라 보통 4계층과 7계층으로 나뉜다.

- **L4 로드 밸런싱**
    - 일반적인 로드밸런서
    - TCP, UDP 정보(특히 포트 넘버)를 기반으로 로드 밸런싱을 수행한다
    - 최근 로드 밸런서는 L4, L7 기능을 모두 지원하지만, L7 지원 여부와 상관없이 4계층에 대한 정보로만 분산 처리하는 경우를 L4 로드 밸런싱이라 한다
- **L7 로드 밸런싱**
    - HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱을 수행한다
    - HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜을 이해한 후 부하를 분산할 수 있다
    - 일반적으로 이런 장비를 ADC(Application Delivery Controller)라고 부르며 프록시(Proxy) 역할을 수행한다
    - 스퀴드(Squid)나 Nginx에서 수행하는 리버스 프록시와 유사한 기능을 갖고 있다

> #### 💡 참고
> 데이터 센터에서 사용하는 로드 밸런서 장비는 L4, L7을 모두 지원하며, 어떻게 설정했는지에 따라 L4 로드 밸런싱과 L7 로드 밸런싱으로 나뉜다.  
> 반면, 클라우드에서는 L4 로드 밸런싱과 L7 로드 밸런싱을 지원하는 컴포넌트를 계층별로 구분해 전용으로 사용한다.  
> 그 예로, AWS의 NLB(Network Load Balancer)가 L4 로드 밸런싱, ALB(Application Load Balancer)가 L7 로드 밸런싱 전용 컴포넌트이다.

### ❇️ L4 스위치

- L4 스위치는 4계층에서 동작하며 로드 밸런서 기능이 있는 스위치이다
- 스위치처럼 여러 개의 포트를 갖고 있다
- L4 스위치는 부하 분산, 성능 최적화, 리다이렉션 기능을 제공한다
- L4 스위치가 동작하려면 가상 서버, 가상 IP, 리얼 서버, 리얼 IP를 설정해야 한다
    - 가상 서버: 사용자가 바라보는 실제 서비스
    - 가상 IP: 사용자가 접근해야 하는 서비스 IP 주소
    - 리얼 서버: 실제 서비스를 수행하는 서버
    - 리얼 IP: 실제 서버의 IP 주소
- L4 스위치는 가상 IP를 리얼 IP로 변경해주는 역할을 한다  
  (위 방식을 통해 서버의 부하를 분산하게 되는데 이는 12장 로드 밸런서에서 다룬다)

### ❇️ ADC (Application Delivery Controller)

- ADC는 애플리케이션 계층에서 동작하는 로드 밸런서이다
- 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작하며, 부하 분산, 정보 수정, 정보 필터링이 가능하다
- ADC는 이런 상세한 동작을 위해 프락시로 동작한다
- 대부분의 ADC는 4계층에서 애플리케이션 계층까지 로드 밸런싱 기능을 제공하며, 페일오버(Failover, 장애극복 가능), 리다이렉션(Redirection) 기능도 함께 수행한다
- 이 외에도 애플리케이션 프로토콜을 이해하고 최적화하는 다양한 기능을 제공하는데, 캐싱, 압축, 콘텐츠 변환 및 재작성, 인코딩 변환 등이 가능하며, 애플리케이션 프로토콜 최적화 기능도 제공한다
- 플러그인 형태로 보안 강화 기능을 추가로 제공해 WAF(Web Application Firewall) 기능이나 HTML, XML 검증과 변환을 수행할 수 있다

### ❇️ L4 스위치 vs ADC

- L4 스위치
    - 4계층에서 동작하면서 TCP, UDP 정보를 기반으로 부하를 분산시킨다
    - TCP 계층에서의 최적화와 보안 기능도 함께 제공할 수 있다
    - TCP 레벨의 간단한 **DoS(Denial of Service) 공격을 방어**하거나 서버 부하를 줄이기 위해 **TCP 세션 재사용**과 같이 **보안과 성능**을 높여주는 기능도 있다
- ADC
    - ADC는 애플리케이션 내용에 대한 분산, 리다이렉션, 최적화를 제공하여 L4 스위치보다 더 다양한 기능을 사용할 수 있다
    - ADC는 성능 최적화를 위해 서버에서 수행하는 작업 중 부하가 많이 걸리는 작업을 별도로 수행하는데, 대표적으로 이미지나 정적 콘텐츠를 캐싱(Caching)하는 기능이다
    - ADC는 하드웨어 가속이나 소프트웨어 최적화를 통해 부하가 많이 걸리는 작업을 최적화 하는 기능이 있다
    - 보안을 위해 사용되는 SSL 프로토콜에서 암복호화 부하가 많이 일어나는데, 이를 ADC에서는 SSL의 엔드포인트로 동작해 클라이언트에서 ADC까지의 구간을 SSL로 처리해주고, ADC와 웹 서버 사이를 일반 HTTP를 이용해 통신을 한다


<br/>
---

## 3️⃣ 방화벽

- 방화벽은 네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용(Permit)하거나 차단(Deny)하는 장비이다
- 3, 4계층에서 동작하여 세션을 인지, 관리하는 SPI(Stateful Packet Inspection) 엔진을 기반으로 동작한다
- 방화벽은 NAT(Network Address Translation) 동작 방식과 유사하게 세션 정보를 장비 내부에 저장한다
- 세션 테이블을 통해 패킷이 외부에서 처음 시작된 것인지, 내부 사용자가 외부로 요청한 응답인지를 가려낸다
- 세션 테이블을 이용해 패킷의 인과 관계를 파악할 수 있어 정책을 간단히 유지할 수 있다
    - 만약, 세션의 방향성을 파악하지 못한다면 많은 정책을 복잡하게 관리해야 한다
    - 인터넷 방화벽에서의 기본 정책은 인터넷으로 나가는 모든 패킷을 허용하고 내부로 들어오는 모든 패킷을 차단하는 것이다

<br/>
---

## 4️⃣ 4계층 장비를 통과할 때의 유의점 (세션 관리)

- 애플리케이션과 세션 장비 간 세션 정보를 동일하게 유지해 주어야 한다
- 애플리케이션을 제작할 때 네트워크 중간에 있는 세션 장비를 고려해 기능을 추가해야 한다
- 특히 애플리케이션의 세션 시간과 서비스 방향성을 고려하고, 비대칭 경로를 피하는 것이 매우 중요하다

### ❇️ 세션 테이블 유지, 세션 정보 동기화

- 종단 장비에서 통신이 시작되면 중간에 있는 세션 장비는 해당 세션의 상태를 상태 테이블에 기록한다
- 통신이 정상적으로 종료되지 않은 경우를 위해 일정 시간 동안 세션 테이블에 유지했다가 타임아웃이 지나면 제거된다
- 또한, 악의적인 공격자가 과도한 세션을 발생시켜 정상적인 세션 테이블 생성을 방해하는 세션 공격으로부터 시스템을 보호하기 위해 타임아웃을 사용한다

하지만 일부 애플리케이션은 긴 시간의 타임아웃을 설정하기도 한다.  
이런 애플리케이션의 경우 세션 장비의 세션 타임아웃값이 애플리케이션의 세션 타임아웃값보다 짧으면 통신에 문제가 생긴다.  
중간 세션 장비의 세션 유지 시간이 지나 세션 테이블에 있는 세션 정보가 사라졌는데도 양쪽 단말에서는 세션이 유지되고 있다면 다시 통신이 시작되어 데이터를 보낼 때 중간 세션 장비에서 막히는 문제가 발생한다.

이런 문제를 해결하기 위해 세션 장비와 애플리케이션에서 각각 적용할 수 있는 설정이 있다.

#### 세션 장비 운영자 입장

1) 세션 만료 시간 증가
2) 세션 시간을 둔 채로 중간 패킷을 수용할 수 있도록 방화벽 설정(세션 장비 중 방화벽에 해당)
3) 세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보

#### 개발자 입장

1) 애플리케이션에서 주기적인 패킷 발생 기능 추가


### ❇️ 비대칭 경로 문제

네트워크의 안정성을 톺이기 위해 네트워크 회선과 장비를 이중화한다.  
이때 패킷이 지나가는 경로가 2개 이상이므로 인바운드 패킷과 아웃바운드 패킷의 경로가 같거나 다를 수 있다.  
인바운드 패킷과 아웃바운드 패킷이 같은 장비를 통과하는 것을 대칭 경로(Symmetric Path)라고 하고, 다른 장비를 통과하는 것을 비대칭 경로(Asymmetric Path)라고 한다.
