# 12장. 로드 밸런서

1) 부하 분산이란?
2) 부하 분산 방법
3) 헬스 체크
4) 부하 분산 알고리즘
5) 로드 밸런서 구성 방식
6) 로드 밸런서 동작 모드
7) 로드 밸런서 유의사항
8) HAProxy를 사용한 로드 밸런서 설정

---
<br/>

## 1️⃣ 부하 분산이란?

- 서비스 규모가 커지면 단일 서버로는 모든 트래픽을 수용하기에는 한계가 있다
- 또한, 단일 서버로 구성하여 서비스 할 경우 해당 서버의 애플리케이션, 운영체제, 하드웨어 등에 장애가 발생했을 때 안전한 서비스 운영이 어렵다
- 이러한 문제. 즉, 서비스 가용성을 높이기 위해 두 대 이상의 서버로 구성하여 L4나 L7스위치라는 로드 밸런서를 통해 부하를 분산시켜 서비스를 운영해야 한다
- 로드밸런서는 가상 IP(VIP)를 하나 제공하고 사용자는 각 서버의 개별 IP가 아닌 가상 IP 하나만으로 서버에 접근하며
- 로드밸런서에서는 가상 IP(VIP)를 하나 제공하면 사용자는 각 서버의 개별 IP가 아닌 로드밸런서의 가상 IP를 통해 모든 서비스에 접근이 가능하다
- 또한, 로드밸런서는 각 서버의 서비스 상태를 체크하여 서비스가 가능한 서버로만 사용자의 요청을 분산하므로 장애가 발생하더라도 문제 없이 서비스 제공이 가능하다

## 2️⃣ 부하 분산 방법

- 로드밸런서에서는 서비스를 제공하는 실제 서버의 IP인 리얼 IP(RIP)와 로드밸런서에서 서비스를 대표하는 가상 IP(VIP)가 있다
- VIP에는 RIP가 바인딩되어 있고, 사용자가 VIP로 서비스를 요청하면 해당 VIP에 연결된 RIP로 해당 요청을 전달한다
- 로드밸런서에서는 부하 분산을 위한 그룹을 만들 수 있다
- 그룹을 만들 때에는 OSI 3계층 정보인 IP 주소뿐만 아니라 4계층 정보인 서비스 포트까지 지정해 만든다
- 그래서 로드밸런서를 L4 스위치라고 부른다
- 간혹 7계층 정보까지 확인해 처리하는 기능이 포함되는 경우도 있는데, 이 떄문에 L7 스위치라고도 하지만 보통 로드밸런서를 L4 스위치라고 부른다

## 3️⃣ 헬스 체크

- 로드밸런서에서는 부하 분산을 하는 각 서버의 서비스를 주기적으로 헬스 체크하여 정상적인 서비스 쪽으로만 부하를 분산하고, 비정상적인 서버는 서비스 그룹에서 제외해 트래픽을 보내지 않는다

### ❇️ 헬스 체크 방식

자주 사용되는 헬스체크 방식들은 다음과 같다

- **ICMP**
  - VIP에 연결된 리얼 서버에 대해 ICMP(ping)로 헬스 체크를 수행하는 방법이다
  - 단순히 서버가 살아 있는지 여부만 체크하는 방법이므로 잘 사용되지 않는다
- **TCP 서비스 포트**
  - 가장 기본적인 헬스 체크 방법은 로드밸런서에 설정된 서버의 서비스 포트를 확인하는 것이다
  - 즉, 로드 밸런서에서 등록된 서버의 서비스 포트에 SYN을 보내고 해당 리얼 IP를 가진 서버로부터 SYN, ACK를 받으면 서버에 다시 ACK로 응답하고 FIN을 보내 헬스 체크를 종료한다
  - 서비스 포트를 이용해 헬스 체크를 할 때는 실제 서비스 포트가 아닌 다른 서비스 포트로도 가능하다
- **TCP 서비스 포트: Half Open**
  - 일반 서비스 포트를 확인할 때는 SYN/SYN, ACK/ACK까지 정상적인 3방향 핸드셰이크를 거치게 된다
  - 헬스 체크로 인한 부하를 줄이거나 정상적인 종료 방식보다 빨리 헬스 체크 세션을 끊기 위해 정상적인 3방향 핸드셰이크와 4방향 핸드셰이크가 아닌 TCP Half Open 방식을 사용하기도 한다
  - TCP Half Open 방식은 초기의 3방향 핸드셰이크와 동일하게 SYN을 보내고 SYN, ACK를 받지만 이후 ACK 대신 RST를 보내 세션을 끊는다
- **HTTP 상태 코드**
  - 웹 서비스를 할 때, 서비스 포트까지는 TCP로 정상적으로 열리지만 웹 서비스에 대한 응답을 정상적으로 해주지 못하는 경우가 있다
  - 이때 로드 밸런서의 헬스 체크 방식 중 HTTP 상태 코드를 확인하는 방식으로 로드밸런서가 서버로 3방향 핸드셰이크를 거치고 나서 HTTP를 요청해 정삭적인 상태 코드(200 OK)를 응답하는지 여부를 체크해 핼스 체크를 수행할 수 있다
- **콘텐츠 확인 (문자열 확인)**
  - 로드 밸런서에서 서버로 콘텐츠를 요청하고 응답받은 내용에서 지정된 콘텐츠가 정삭적으로 응답했는지 여부를 확인하는 헬스 체크 방법이다
  - 보통 특정 웹페이지를 호출해 사전에 지정한 문자열이 해당 웹페이지 내에 포함되어 있는지를 체크하는 기능이다
  - 이 헬스 체크 방식을 사용하면 로드 밸런서에서 직접 관리하는 서버의 상태뿐만 아니라 해당 서버의 백엔드의 상태를 해당 웹페이지로 체크할 수 있다
  - 한 가지 유의사항은, 문자열만 체크하므로 에러 코드에 대한 응답인 경우라도 해당 문자열이 포함되어 있다면 정상으로 판단할 가능성이 있기 때문에 체크할 문자열을 잘 지정해주는 것에 유의해야 한다

### ❇️ 헬스 체크 주기와 타이머

- **주기(Interval)**
  - 로드 밸런서에서 서버로 헬스 체크 패킷을 보내주는 주기
- **응답 시간(Response)**
  - 로드 밸런서에서 서버로 헬스 체크 패킷을 보내고 응답을 기다리는 시간
  - 해당 시간까지 응답이 오지 않으면 실패로 간주
- **시도 횟수(Retries)**
  - 로드 밸런서에서 헬스 체크 실패 시 최대 시도 횟수
  - 최대 시도 횟수 이전에 성공 시 시도 횟수는 초기화됨
- **타임아웃(Timeout)**
  - 로드 밸런서에서 헬스 체크 실패 시 최대 대기 시간
  - 헬스 체크 패킷을 서버로 전송한 후 이 시간 내에 성공하지 못하면 해당 서버는 다운
- **서비스 다운 시의 주기(Dead Interval)**
  - 서비스의 기본적인 헬스 체크 주기가 아닌, 서비스 다운 시의 헬스 체크 주기
  - 서비스가 죽은 상태에서 헬스 체크 주기를 별도로 더 늘릴 때 사용

## 4️⃣ 부하 분산 알고리즘

- **라운드 로빈 (Round Robin)**
  - 특별한 규칙 없이 현재 구성된 장비에 순차적으로 돌아가면서 트래픽을 분산한다
  - 순차적으로 모든 장비에 분산하므로 모든 장비의 총 누적 세션 수는 같다
- **최소 접속 방식 (Least Connection)**
  - 서버가 가진 세션 부하를 확인하여 그것에 맞게 부하를 분산하는 방식이다
  - 로드 밸런서에서는 서비스 요청을 각 장비로 보내줄 떄마다 세션 테이블이 생성되어, 각 장비에 연결된 현재 세션 수를 알 수 있다
  - 서비스별로 세션 수를 관리하면서 분산하므로 각 자입에서 처리되는 활성화 세션 수가 비슷하게 부하를 분산하게 된다
- **해시**
  - 서버의 부하를 고려하지 않고 클라이언트가 같은 서버에 지속적으로 접속하도록 하기 위해 사용하는 부하 분산 방식이다
  - 해시 알고리즘을 이용해 얻은 결괏값으로 부하 분산을 결정한다
  - 이때, 알고리즘 계산에 사용되는 값들을 지정할 수 있는데 주로 출발지 IP 주소, 목적지 IP 주소, 출발지 서비스 포트, 목적지 서비스 포트를 사용한다
  - 해시 방식은 항상 동일한 장비로 서비스가 분산된다
  - 즉, 세션을 유지해야 하는 서비스에 적합한 분산 방식이다
  - 흔히 장바구니 문제에서 발생하는데, A 서버에 접속해 장바구니에 상품을 넣었는데 두 번째 접속할 때 B 서버로 접속되면 장바구니에 넣은 상품이 보이지 않을 때가 있다
  - 그러나 해시 방식은 부하 분산 비율이 한쪽으로 치우칠 가능성이 있다
  - 그래서 해시와 최소 접속 방식의 장점을 묶어 사용하는 방법도 있는데, 이는 스티키(Sticky) 옵션을 주어 한 번 접속한 커넥션을 지속적으로 유지하는 기법이다
  - 즉, 처음 들어온 서비스 요청을 세션 테이블에 두고 같은 요청이 들어오면 같은 장비로 분산해 세션을 유지하는데, 타임아웃이 있어서 타임 아웃 이후에는 분산되는 장비가 달라지게 된다. 그래서 이에 유의하여 서비스 설계를 해야한다.

## 5️⃣ 로드 밸런서 구성 방식

로드 밸런서의 구성 방식은 로드 밸런서의 구성 위치에 따라 2가지로 나눌 수 있다

- 원암(One-Arm) 구성
- 인라인(Inline) 구성

### ❇️ 원암 구성

- 원암 구성은 로드 밸런서가 스위치 옆에 있는 형태를 말한다
- 원암 구성은 서버로 들어가거나 나오는 트래픽이 로드밸런서를 경유하거나 경유하지 않을 수 있다
- 트래픽이 로드밸런서를 경유하는지 여부는 부하 분산을 이용한 트래픽인지 여부로 구분할 수 있다

### ❇️ 인라인 구성

- 로드밸런서가 스위치에서 서버까지 가는 일직선상 경로에 있는 형태를 말한다
- 인라인 구성은 트래픽이 흐르는 경로에 로드밸런서가 있어서 서버로 향하는 트래픽이 로드밸런서의 서비스를 받는지 여부와 상관없이 로드밸런서를 모두 통과한다
- 즉, 모든 트래픽이 로드밸런서를 거치므로 부하가 높아진다
- 특히 일반 L3 역할을 하는 스위치에 비해 로드밸런서는 4계층 이상의 데이터를 처리하므로, 용량이 L3 장비보다 적으며 처리 용량은 커지면서 가격도 많이 상승한다
- 그래서 인라인으로 로드밸런서를 선정할 때 로드밸런싱 성능과 패킷 스루풋 성능을 구별해 디자인해야 한다

## 6️⃣ 로드 밸런서 동작 모드

로드 밸런서 동장 방식은 크게 다음의 3가지이다

- 트랜스패런트(Transparent: TP) 또는 브릿지(Bridge)
- 라우티드(Routed)
- DSR(Direct Server Return)

### ❇️ Transparent 모드

- Transparent(투명) 구성은 로드밸런서가 OSI 2계층 스위치처럼 동작하는 구성이다
- 즉, 로드밸런서에서 서비스하기 위해 사용하는 VIP 주소와 실제 서버가 동일한 네트워크를 사용하는 구성이다
- 트래픽이 로드밸런서를 지나더라도 부하 분산 서비스를 받는 트래픽인 경우에만 4계층 이상의 기능을 수행하며, 아닌 경우에는 L2 스위치와 동일한 스위칭 기능만 수행한다. (그래서 이 구성을 L2 구조라고 부르기도 한다)
- 트랜스패런트 모드는 원암과 인라인 구성에서 모두 사용할 수 있는 동작모드이다
- 다만 원암 구성에서는 응답 트래픽 경로 부분이 문제가 될 수 있어 Source NAT가 필요하다

### ❇️ Routed 모드

- 라우티드 구성은 로드밸런서가 라우팅 역할을 수행하는 모드이다
- 즉, 로드밸런서를 기준으로 클라이언트 방향과 서버 방향이 서로 다른 네트워크로 분리된 구성이다
- 원암과 인라인 구성 모두 사용할 수 있다
- 라우티드 모드는 보안 강화 목적으로 서버쪽 네트워크를 사설로 구성해 서버에 직접 접속하는 것을 막는 용도로 사용되기도 한다

### ❇️ DSR(Direct Server Return) 모드

- DSR 모드는 사용자의 요청이 로드밸런서를 통해 서버로 유입된 후에 다시 로드밸런서를 통하지 않고 서버가 사용자에게 직접 응답하는 모드이다
- 로드밸런서에는 응답 트래픽이 유입되지 않으므로 사용자가 요청하는 패킷에 대해서만 관여한다
- DSR 모드는 응답할 때 로드밸런서를 경유하지 않으므로 원암으로 구성한다
- DSR 모드는 로드밸런서에서 실제 서버까지의 통신이 L2 통신인지, L3 통신인지에 따라 L2 DSR과 L3 DSR로 나눌 수 있다
  - L2 DSR: 실제 서버의 네트워크를 로드밸런서가 가진 경우
  - L3 DSR: 실제 서버의 네트워크 대역을 로드밸런서가 가지지 않은 경우
- DSR 모드는 요청 트래픽만 처리하므로 전체 트래픽이 감소해 로드밸런서 부하가 감소한다
- 특히 일반적으로 서비스 요청 패킷보다 응답 패킷의 크기가 더 크기 때문에 로드밸런서의 트래픽 부하 감소에 효과적이다
- 그러나, DSR 모드는 응답 패킷이 로드밸런서를 경유하지 않으므로 문제가 발생했을 때 확인이 어렵다

## 7️⃣ 로드 밸런서 유의사항

## 8️⃣ HAProxy를 사용한 로드 밸런서 설정

- HAProxy는 기존 하드웨어 로드밸런서의 역할을 일반 서버에서 직접 수행하게 해주는 오픈소스 기반의 소프트웨어 로드밸런서이다
- HAProxy는 간단한 설정만으로 바로 사용할 수 있어 하드웨어 로드밸런서를 구축해야 하는 환경과 달리 로드밸런서 서비스를 신속하게 제공할 수 있다
- 소프트웨어 형태이므로 가상화나 클라우드 환경에서 로드밸런서로 사용하기에 매우 적합한 솔루션이다
- 또한, 쿠버네티스의 인그레스 컨트롤러(Ingress Controller) 역할도 할 수 있다
- HAProxy는 초기에 오픈 소스의 일반 커뮤니티 버전만 있었지만 현재는 추가 서비스 모듈, 도구, 지원 서비스를 포함한 엔터프라이즈 버전도 함께 제공하고 있다
- 또한, HAProxy를 적용한 하드웨어 어플라이언스 형태의 모델인 ALOHA 로드 밸런서도 제공하고 있다