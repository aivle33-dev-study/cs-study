# Ch09. 보안

---

**Contents**

9.1 보안의 개념과 정의

9.2 보안 솔루션의 종류

9.3 방화벽

9.4 IPS, IDS

9.5 DDos 방어 장비

9.6 VPN

---

<br><br>

# 9.1 보안의 개념과 정의

- 보안
    
    안전을 지키는 일
    
    위험이 생기거나 사고가 날 염려 없이 편안하고 온전한 상태를 지키는 모든 활동
    

## 9.1.1 정보 보안의 정의

- 3대 보안 정의 : 보안의 필수 요소
    - 기밀성(Confidentiality)
        - 인가되지 않은 사용자가 정보를 보지 못하게 하는 모든 작업
        - 대표적인 기밀성은 암호화 작업
    - 무결성(Integrity)
        - 정확하고 완전한 정보 유지에 필요한 모든 작업
        - 누군가 정보를 고의로 훼손하거나 중간에 특정 이유로 변경이 가해졌을 때, 그것을 파악해 잘못된 정보가 전달되거나 유지되지 못하게 하는 것
        - 대표적인 무결성 기술: MD5, SHA같은 Hash 함수를 이용해 변경 여부를 파악하는 것
    - 가용성(Availability)
        - 정보가 필요할 때, 접근을 허락하는 일련의 작업
        - 정보를 사용할 수 없는 상황이라면 정보 보안에 실패한 것이므로 중요함

- 3대 보안 정의 외의 추가 요소
    - 진정성
    - 책임성
    - 부인 방지
    - 신뢰성 유지

## 9.1.2 네트워크의 정보 보안

- 네트워크 입장에서의 정보 보안
    - 수집된 정보를 침해하는 행동을 기술적으로 방어하거나, 정보의 송수신 과정에 생기는 사고를 막기위한 작업
    - 네트워크 보안의 1차 목표
        
        네트워크 시스템을 공격해 정상적으로 구동할 수 없게 만드는 행위를 네트워크에서 적절히 막는 것
        
    - 네트워크 보안의 2차 목표
        
        네트워크를 통해 복제, 이동되므로 그 유출을 막는 것
        
    - BOTTOM-UP 형식으로 네트워크 보안이 발전됨
    - 네트워크는 중요한 정보유출 영역
        
        네트워크를 장악하면 많은 시스템에 더 쉽게 접근할 수 있어 침해 범위를 넓히고 외부 침입자가 원하는 정보가 유출될 가능성이 커짐
        
        외부 공격에 맞서는 중요한 1차 방어선이라고 볼 수 있음
        

## 9.1.3 네트워크의 보안의 주요 개념

- 네트워크 보안의 목표
    
    외부 네트워크로부터 내부 네트워크를 보호하는 것
    
- 정보 보안별 네트워크의 종류
    - 트러스트(Trust) 네트워크
        
        : 외부로부터 보호받아야 할 네트워크
        
    - 언트러스트(Untrust)네트워크
        
        : 신뢰할 수 없는 외부 네트워크
        
    
    cf. 우리가 운영하는 내부 네트워크이지만, 신뢰할 수 없는 외부 사용자에게 개방해야하는 서비스 네트워크인 경우 **DMZ(DeMilitarized Zone) 네트워크**라고 부르며 일반적으로 인터넷에 공개되는 서비스를 이 네트워크에 배치
    

- 트래픽의 방향과 용도에 따라 나뉘는 네트워크 보안 분야
  
    - **인터넷 시큐어 게이트웨이(Internet Secure Gateway)**
      
        - 트러스트(또는 DMZ) 네트워크에서 언트러스트 네트워크로의 통신을 통제
          
        - 인터넷으로 나갈때는 인터넷에 수많은 서비스가 있으므로 그에 대한 정보와 요청 패킷을 적절히 인식하고 필터링하는 기능이 필요
          
        - **방화벽, SWG(Secure Web Gateway), 웹 필터(Web Filter), 애플리케이션 컨트롤(Application Control), 샌드박스(Sandbox)와 같은 다양한 서비스나 네트워크 장비가 포함됨**
          
        - 이런 서비스와 보안 장비들은 내부 사용자가 인터넷으로 통신할 때 보안을 제공 통제하기 위해 사용
     
  
    - **데이터 센터 시큐어 게이트웨이(Data Center Secure Gateway)**
      
        - 언트러스트 네트워크에서 트러스트(또는 DMZ)로의 통신을 통제
          
        - 데이터 센터 게이트웨이는 상대적으로 고성능이 필요하고 외부의 직접적인 공격을 막아야 하므로 인터넷 관련 정보보다 공격 관련 정보가 더 중요
          
        - 방화벽, IPS, DCSG(DataCenter Secure Gateway), WAF(Web Application Firewall), Anti-DDoS(Distribute Denial of Service) 등의 장비가 이런 용도로 사용됨


1. **네트워크 보안 정책에 따른 분류**
    
    네트워크 보안 정책 수립에 따라 네트워크 보안은 두 가지로 나눌 수 있음
    
    - **화이트리스트(White List)**
        - 방어에 문제가 없다고 명확히 판단되는 통신만 허용하는 방식
        - 일반적으로 IP와 통신 정보에 대해 명확히 아는 경우에 사용
            
            e.g. 회사 내부에서 사용하는 방화벽이 명확한 정책에 의해 필요한 서비스만 허용하는 경우 
            
    - **블랙리스트(Black List)**
        - 공격이라고 명확히 판단되거나 문제가 있었던 IP 리스트나 패킷 리스트를 기반으로 데이터베이스를 만들고 그 정보를 이용해 방어하는 형태
        - 각종 패턴으로 공격을 방어하는 네트워크 장비(IPS, 안티바이러스, WAF)들은 일반적으로 블랙리스트 기반의 방어 기법을 제공
        - 인터넷 어디선가 공격을 당할 때 이것을 분석해 공격 기법을 판단해 탐지하도록 간단히 적어 데이터베이스로 만듦
        - 이런 데이터베이스를 공격 패턴(시그니쳐: Signature)라고 함

- 네트워크 보안 장비는 화이트리스트나 블랙리스트 기반 중 하나만 목표로 만들 때도 있음
    
    e.g. IPS와 안티바이러스가 블랙리스트 기반 장비
    
- 하지만, 보통 화이트리스트와 블랙리스트 기법 모두 사용할 수 있음
- 같은 방화벽이라도 IP 주소 정책을 잘 아는 IP만 들어오게 화이트리스트 기반 정책으로 운영할 수 있음
- 반대로 해킹을 시도했던 IP 리스트를 작성해 차단하는 블랙리스트 기반으로 운영될 수 있음

2. **정탐, 오탐 미탐(탐지 에러 타입)**
    
    IPS나 안티바이러스와 같은 네트워크 장비는 공격 데이터베이스에 따라 공격과 악성 코드를 구분해 방어
    
    공격 데이터베이스를 아무리 정교하게 만들더라도 공격으로 탐지하지 못하거나 공격이 아닌데 감지하여 패킷을 드롭시킬 때가 있음
    
    블랙리스트 기반 데이터베이스를 이용한 방어는 이런 문제점이 있으므로 장비 도입 시 정교한 튜닝이 필요
    
    공격을 탐지할 때 원래 예상한 내용과 다른 결과가 나올 수 있음
    
    이런 경우를 오탐지, 미탐지(오탐, 미탐)로 구분하고 정상적으로 탐지한 경우를 정상 탐지(정탐)으로 표현
    
    예상했던 상황과 탐지 결과에 따라 4가지 경우가 나타남
    
    |  | 공격 상황 | 정상 상황 |
    | --- | --- | --- |
    | 공격 인지 | True Positive(정상 탐지) | False Positive(오 탐지) |
    | 정상 인지 | True Nagative(미 탐지) | False Nagative(정상 탐지) |
    
    False Positive(오탐)과 True Negative(미탐)은 공격으로 오인한 탐지이므로 이런 경우가 발생하면 예외로 처리해 오탐을 줄이는 튜닝 작업이 필요
    
    True Negative는 공격 패턴에 대한 업데이트가 되지 않아써나 과도한 예외 처리로 공격 패킷 탐지가 정상적으로 되지 않았을 때 발생
    
    또한, 공격 데이터베이스가 업데이트되기 전에 발생하는 '제로 데이 공격(Zero-Day Attack)'이 발생했을 때도 True Positive 오류가 생김
    

## 9.1.4 네트워크 정보 보안의 발전 추세와 고려사항

IT 정보 보안 영역에서 네트워크가 중요한 만큼 네트워크에서 동작하는 보안 장비나 서비스의 종류가 많다.

네트워크 보안 장비와 서비스가 개발되는 이유를 이해하면 장비들의 역할도 쉽게 학습하고 향후 발전 방향도 추측할 수 있다.

네트워크 보안 장비는 보안 영역 외부와 내부의 변화로 발전하게 되된다.

보안 영역 외부의 변화는 인프라 스트럭처나 서비스의 대변화로 인해 보안이 따라서 발전해야 하는 경우를 의미하고, 보안 영역 내부는 해킹 기술의 발전에 대응하다보니 새로운 보안 장비와 서비스가 개발되어 발전하는 경우를 의미한다.

네트워크나 서비스의 큰 변화는 보통 필요에 의한 변화이므로 보안이 고려되지 않는 경우가 많다.

이런 경우, 보안을 뒤늦게 고려하여 보안 내부적인 변화가 아니어서 쉽게 대응하기 어렵다.

최근 IT 산업 자체에 큰 변화가 있고 보안이 그 변화를 쫒아가는데 큰 어려움을 겪고 있지만, 반대로 이런 변화를 수용해 보안 장비가 발전하기도 한다.

빅데이터와 머신러닝 부분이 특히 그렇다!

빅데이터와 머신 러닝 기법을 보안에 적용해 공격에 더 신속히 대응하는 시스템과 서비스를 개발하여 더 높은 수준의 네트워크 보안을 제공한다.

<br><br>

# 9.2 보안 솔루션의 종류

보안 장비의 위치와 역할에 따라 다양한 네트워크 보안 장비가 있음

- 네트워크 전체 구성도(네트워크 보안 솔루션 위치)
    
    ![네트워크_그림9-6](https://github.com/aivle33-dev-study/cs-study/assets/90406411/0361830d-6a86-40f5-9aca-6ccd9304ea7a)
    
    - 데이터 센터에서 보안 장비를 디자인할 때 **DDoS - 방화벽 - IPS - WAF** 형태와 같이 여러 단계로 공격을 막도록 인라인 상에 여러 장비를 배치
    - 모든 공격을 장비 한 대로는 방어할 수 없으므로 여러 장비의 기능으로 단계적으로 방어

## 9.2.1 DDoS 방어 장비

<그림 9-7>

- DoS 공격
    - 'Denial of Service' 공격의 약자로, 다양한 방법으로 공격 목표에 서비스 부하를 가해 정상적인 서비스를 방해하는 공격 기법
    - 비교적 탐지가 쉽고 짧은 시간안에 탐지만 할 수 있다면 IP 주소 기반으로 충분히 방어 가능
    - 이런 탐지를 회피하고 더 짧은 시간안에 공격 성과를 내기 위해 다수의 봇(bot)을 이용해 분산 공격을 수행하는DDoS 공격 기법이 등장
- **DDoS 장비**
    - **DDoS 공격을 방어하는 보안 장비**
    - 데이터 센터 **네트워크 내부와 외부의 경계에서 공격을 방어하는데 이것은 볼류메트릭 공격(Bolumetric Attack)을** 우선 막기 위함
        - 볼류메트릭 공격 : 회선 사용량이나 그 이상의 트래픽을 과도하게 발생시켜 회선 사용을 방해하는 공격으로, 회선을 공급해주는 ISP나 네트워크 ISP와 연결되는 데이터 센터 네트워크의 가장 바깥쪽에 위치시켜 이 공격을 완화(Mitigation)해야 함

## 9.2.2 방화벽

- 방화벽
    - 4계층에서 동작하는 패킷 필터링 장비
    - 3, 4계층 정보를 기반으로 정책을 세울 수 있고 해당 정책과 매치되는 패킷이 방화벽을 통과하면 그 패킷을 허용(Allow, Permit)하거나 거부(Deny)할 수 있음
    - 일반적으로 DDoS 방어 장비 바로 뒤에 놓는 네트워크 보안 장비임

## 9.2.3 IDS, IPS

- **IDS(Intrusion Detection System: 침입 탐지 시스템),
IPS(Intrusion Prevention System: 침입 방지 시스템)**
    - 방화벽에서 방어할 수 없는 다양한 애플리케이션 공격을 방어하는 장비
    - 기존에는 IDS와 IPS 장비를 구분했지만 최근에는 애플리케이션 공격을 방어하는 장비를 IPS로 통칭
    - IDS와 IPS는 사전에 공격 데이터베이스(Signature)를 제조사나 위협 인텔리전스(Threat Intelligence) 서비스 업체로부터 받음
    - 기존에는 공격인 것만 골라 방어하는 블랙리스트 기반의 방어 방식만 제공
    - 하지만 프로파일링 기반의 방어 기법이 IPS 장비에 적용되고 애플리케이션을 골라 방어할 수 있는 애플리케이션 컨트롤(Application Control)기능이 추가되면서 화이트리스트 기반의 방어 기법도 IPS 장비에 적용 가능
    - 최근에는 데이터 센터 영역의 보안을 위해 방화벽과 IPS 장비를 통합한 DCSG 장비시장이 커지고 있음

## 9.2.4 WAF

- WAF(Web Application Firewall)
    - 웹 서버를 보호하는 전용 보안 장비로 HTTP, HTTPS처럼 웹 서버에서 동작하는 웹 프로토콜의 공격을 방어
    - IDS/IPS 장비보다 범용성이 떨어지지만 웹 프로토콜에 대해서는 더 세밀히 방어
    - WAF는 다음과 같은 다양한 형태의 장비나 소프트웨어로 제공
        
        - 전용 네트워크 장비
        
        - 웹 서버의 플러그인
        
        - ADC 플러그인
        
        - 프록시 장비 플러그인
        
    - WAF는 IPS에서 방어할 수 없는 IPS 회피 공격(Evasion Attack)을 방어할 수 있음
    - IPS는 데이터를 조합하지 않고 처리하지만 WAF는 프록시 서버와 같이 패킷을 데이터 형태로 조합해 처리
    - 그래서 회피 공격을 쉽게 만들기 어렵고 데이터의 일부를 수정, 추가하는 기능을 수행할 수 있음
        
        e.g. 공격 트래픽을 방어만 하지 않고 공격자에게 통보하거나 민감한 데이터가 유출될 때, 그 정보만 제거해 보낼 수 있음
        반면, IPS는 공격을 차단한 후 그에 대한 통보가 어렵고 전체 공격 내용에 대한 차단만 가능
        

## 9.2.5 샌드박스

직접적인 공격 기법 중 기존 보안 장비들을 우회하는 기법들이 많아졌지만 근본적으로 공격 방법이 변함

직접적인 공격을 원하는 서버에 접근하지 않고 악성 코드를 관리자 PC에 우회적으로 심고 이 악성 코드를 이용해 관리자 PC를 컨트롤하는 방식으로 공격 목표가 변함

악성 코드가 든 이메일을 관리자에게 보내거나 관리자가 악성 코드를 내려받도록 다양한 방법으로 유도

이후 이 PC들을 외부에서 컨트롤하도록 C&C(Command & Control) 서버를 만들어놓고 감염 PC들이 이 C&C 서버로 연결하도록 조작

이때, 기존 방화벽에서는 내부 사용자가 외부 서버로 통신을 정상적으로 시도한 것으로 보이므로 이 공격을 검출하거나 방어 못함

이 공격들이 발전해 현재 APT(Advanced Persistent Threat: 지능형 지속 공격)와 ATA(Advanced Target Attack: 지능형 표적 공격)이 됨

APT와 ATA의 공격을 막기 위해 IPS 장비와 C&C 서버와의 통신을 탐지할 수 있는 다양한 형태의 Anti-APT 솔루션들이 개발됨

- **샌드박스**
    - **APT의 공격을 방어하는 대표적인 장비로 악성 코드를 샌드박스 시스템안에서 직접 실행**
    - 가상 운영체제 안에서 각종 파일을 직접 실행시키고 그 행동을 모니터링해 그 파일들의 악성 코드 여부를 판별하는 방법을 이용
    - 이 방법은 기존 보안 장비와 보안 솔루션들을 피하는 회피 공격을 탐지하고 기존 보안 솔루션들을 보완함

## 9.2.6 NAC

- NAC(Network Access Control)
    - 네트워크에 접속하는 장치들을 제어하기 위해 개발
    - 네트워크에 접속할 때 인가된 사용자만 내부망에 접속할 수 있고 인가받기 전이나 승인에 실패한 사용자는 접속할 수 없도록 제어하는 기술

## 9.2.7 IP 제어

- IP 제어 솔루션
    - 표면적으로는 NAC 솔루션과 공통적인 기술을 이용하거나 기능이 비슷한 경우도 많음
    - 하지만 IP 제어 솔루션은 국내에서 많이 사용하는 기술로 NAC와 다른 목적으로 개발됨
    - 보안사고 추적이 쉽도록 고정 IP 사용이 권고 지침이 금융권에 내려오면서 IP를 할당하고 추적하는 솔루션이 필요해졌고 할당된 IP를 관리하고 나아가 정확히 의도된 IP 할당이 아니면 정상적으로 네트워크를 사용하지 못하게 하는 기능이 필요
    → 이러한 요구사항들을 구현하기 시작한 것이 IP 제어 솔루션!

## 9.2.8 접근 통제

운영자가 서버, 디비, 네트워크 장비에 직접 접근해 관리하면 각 시스템에서 사용자에 대해 권한을 관리해야 하는데 문제가 발생했을 때, 관리자가 작업 내용을 추적하고 감사하기 어려움

이런 문제를 해결하기 위해 서버나 데이터베이스에 대한 직접적인 접근을 막고 작업 추적 및 감사를 할 수 있는 접근 통제 솔루션이 개발됨

접근 통제 솔루션도 에이전트 기반(Agent Based), 에이전트리스(Agentless), 구현 방법에 따라 다양하게 분류할 수 있지만 대부분 **배스천 호스트(Bastion Host)** 기반으로 구현

서버 접근을 위한 모든 통신은 배스천 호스트를 통해서만 가능

서버 호스트의 방화벽에 배스천 호스트에서 출발한 통신만 허용하고 다른 통신은 모두 방어하도록 설정하고 배스천 호스트의 보안, 감사를 높이면 보안을 강화할 수 있음

이 기법을 발전시킨 것이 접근 통제/감사 솔루션

최근의 접근 통제 솔루션들은 단순한 접근 제어뿐만 아니라 감사, 보안 이슈 대응 등을 위해 사용자가 작업한 모든 이력을 저장

## 9.2.9 VPN

- VPN 장비
    - 사용자 기반의 VPN 서비스를 제공해주는 장비
    - 기존에는 별도의 VPN 서비스를 제공하는 하드웨어가 있었지만 현재는 대부분 방화벽이나 라우터 장비에 VPN 기능이 포함
    - 가장 많이 사용하는 VPN은 IPSEC과 SSL
    - IPSEC은 주로 네트워크 연결용으로 쓰이고 SSLVPN은 사용자가 내부 네트워크에 연결할 때 주로 쓰임

<br><br>

# 9.3 방화벽

네트워크 보안 장비 중 가장 유명하고 대중적인 필수 장비는 방화벽!!

다른 네트워크 보안 장비를 방화벽의 범주에 넣어 구분하기도 하지만, 동작 계층과 기능에 따라 세부적으로 구분할 수 있음

## 9.3.1 방화벽의 정의

- 방화벽
    
    네트워크 중간에 위치해 해당 장비를 통과하는 트래픽을 사전에 주어진 정책 조건에 맞추어 허용하거나 차단하는 장비
    
    일반적으로 네트워크 3, 4계층에서 동작하며 세션을 인지하는 상태 기반 엔진(Stateful Packet Inspection, SPI)으로 동작
    

## 9.3.2 초기 방화벽

- **초기 방화벽**
    
    **패킷의 인과 관계를 확인하지 못하고 장비에 등록된 정책만으로 단순히 패킷을 필터링**
    
    패킷의 세션 정보나 방향성과 상관없이 방화벽에 설정된 정책에 따라 동작하는 초기 방화벽을 스테이트리스(Stateless) 또는 패킷 필터(Packet Filter) 방화벽이라고 함
    
    패킷이 장비에 인입되면 해당 패킷이 방화벽에 설정된 정책에 일치되는 것이 있는지 확인
    
    이때 참조하는 조건: 5-튜플(5-Tuple)
    
    - 5-튜플
        
        패킷의 3, 4계층 헤더 중 Source IP, Destination IP, Protocol No, Source Port, Destination Port 5가지 주요 필드를 뜻함
        

방화벽에 일치된 정책이 있으면 해당 정책에 따라 그 패킷을 허용하거나 차단

인터넷 통신과 같이 불특정 다수 기반의 정책을 정의할 때는 룰셋(RUleset)이 복잡해지고 보안이 약화되는 문제가 있음

또한 패킷 단위의 필터링이므로 5-튜플 외의 3,4계층 헤더를 변조해 공격하면 적절한 방어가 불가능

하지만, 패킷 필터링 자체는 다른 세대의 방화벽 엔진들보다 부하가 적고 간단히 동작하여 없어지지않고 사용되고 있음

## 9.3.3 현대적 방화벽의 등장(SPI 엔진)

**현재 우리가 '방화벽'이라고 부르는 모든 장비는 세션 기반으로 동작하는 상태 기반(SPI) 엔진을 탑재하고 있음**

내부 사용자가 외부의 특정 웹페이지에 접속할 때 3웨이 핸드셰이크(3Way Handshake)를 거친 후, HTTP 요청과 응답 과정을 거침

패킷 필터 방화벽에서 이런 트래픽을 처리하기 위해 정책을 선언하려면 목적지가 불특정 다수의 웹이 될 수 있으므로 외부로 나가는목적지에 대해서는 모든 패킷을 허용해야 함

이렇게 정책을 설정하면 내부에서 외부 웹사이트로 나갈 수는 있지만 외부에서 내부로 들어오는 응답에 대한 정책이 없어 정상적인 통신이 안됨

응답에 대한 정책을 설정해야 한다면 외부의 웹사이트는 불특정이므로 출발지가 모든 IP여야 하고 목적지 서비스 포트는 내부에서 외부 호출 시 랜덤 포트를 지정하므로 마찬가지로 모든 포트가 되어야 함

하지만 이런 정책 설정은 보안상 매우 취약

**이런 문제 때문에 패킷 상태를 인지해 패킷의 인과 관계를 파악할 수 있는 상태 기반 SPI 엔진이 나옴**

SPI 엔진은 패킷의 인과 관계와 방향성을 인지해 정책을 적용할 수 있어 내부 네트워크에서 인터넷으로 통신할 때 유용하게 사용

내부에서 외부 인터넷으로 통신을 시도해 받은 응답과 외부에서 내부로 직접 들어오려는 패킷을 구분할 수 있음

## 9.3.4 방화벽 동작 방식

- 최근 방화벽들은 보안을 강화하고 성능을 높이기 위해 여러 개의 엔진과 다양한 기능을 가지고 이를 위해 동작 방식이나 패킷 처리 순서가 다름
- 방화벽이 패킷을 처리하는 순서
    
    1. 장비에 패킷이 들어오면 우선 세션 상태 테이블을 확인
    
    2. 조건에 맞는 세션 정보가 세션 테이블에 있을 때, 포워딩 테이블을 확인(라우팅, ARP 포함)
    
    3. 조건에 맞는 세션 정보가 세션 테이블에 없을 때, 방화벽 정책을 확인
    
    4. 방화벽 정책은 맨 위의 정책부터 확인해 최종 정책까지 확인한 후 없을 때 암시적인 거부(Implicit Denial) 규칙을 참고해 차단
    
    5. 허용 규칙이 있으면 내용을 세션 테이블에 적어 넣음
    
    6. 포워딩 테이블을 확인(라우팅, ARP 포함)
    
    7. 조건에 맞는 정보가 포워딩 테이블에 있을 때, 적절한 인터페이스로 패킷을 포워딩
    
    8. 조건에 맞는 정보가 포워딩 테이블에 없을 때, 패킷을 폐기
    
- SPI 엔진을 가진 방화벽은 세션 인지 기능이 있어 단순히 5-튜플 조건만 확인하는 것이 아니라 OSI 3, 4계층의 세부적인 필드도 함께 확인
- TCP 컨트롤 플래그에 따라 동작 방식이 변하거나 시퀀스와 ACK 번호가 갑자기 변경되는 것을 인지해 세션 탈취 공격을 일부 방어
    
    → TCP Anti-Replay 기능
    
- 세션을 추가로 인지하고 세션 테이블에 저장하므로 세션을 로깅하기 쉬움
- 대부분의 방화벽은 통신 전체의 세션을 로그로 저장 → 보안사고시 세션 로그를 기반으로 어떤 통신에 문제가 있었는지 판단 가능

## 9.3.5 ALG

방화벽은 패킷 필터 엔진보다 헤더 정보를 상세히 확인하고 세션을 인지할 수 있지만 애플리케이션 헤더 정보를 인지하지 못함

세션 방화벽 등장 이전에 개발된 고대 프로토콜은 방화벽과 같은 세션 장비를 고려하지 못해 방화벽이 있으면 통신이 불가능한데, 가장 대표적인 프로토콜이 **FTP**

- FTP
    - 컨트롤 프로토콜과 데이터를 보내는 데이터 프로토콜이 분리되어 동작
    - 컨트롤 프로토콜과 데이터 프로토콜이 반대로 세션을 맺으므로, 방화벽이 FTP 프로토콜을 이해해 동작하지 않으면 정상적인 서비스가 불가능
    - FTP의 기본 동작
        
        1. 클라이언트는 랜덤 포트 2000을 통해 서버 커맨드(Command) 포트 21에 접속하고 데이터 포트로 사용할 2001(n+1)번 포트 정보를 서버에 전송
        
        2. 서버에서 클라이언트의 커맨드 포트(21)에 응답
        
        3. 서버는 서버의 데이터 포트(20)를 클라이언트의 데이터 포트(2001)에 접속
        
        4. 클라이언트에서 서버의 데이터 포트에 응답
        
    - 세션 기반으로 동작하는 방화벽은 세션의 방향성이 매우 중요한데 FTP 액티브 모드(Active Mode)에서는 초기 접속 방향과 반대로 데이터 프로토콜이 동작하므로 방화벽을 정상적으로 통과할 수 없음
 
    - 이 문제를 해결하기 위해 FTP 통신 방식을 패시브 모드로 변경하면 되지만 패시브 모드 자체를 제공하지 못하는 컴포넌트가 있을 수 있고 이미 개발된 애플리캐이션 변경이 불가능한 경우도 있음
      
    - **그래서 방화벽에서 FTP 액티브 모드를 통과시키기 위해 애플리케이션 프로토콜을 확인하고 필요에 따라 세션을 인지해 포트를 자동으로 열어줌**
        
        → **ALG(Application Layer Gateway) 기능**
        
    
- **ALG(Application Layer Gateway) 기능**
  
    - 기능이 동작하는 방화벽에서 PAT를 정상적으로 통과하지 못하는 프로토콜들을 자동으로 인지해 애플리케이션 정보를 변경해주거나 세션 테이블을 만들어주는 작업을 수행
      
    - FTP ALG 기능이 동작하려면 패킷이 방화벽을 지나갈 때, 방화벽이나 해당 패킷이 참조되는 정책에 ALG 기능이 활성화되어 있어야 함

- FTP 프로토콜이 방화벽을 지나갈 때의 방화벽 동작 순서
    
    1. FTP ALG 기능은 초기 FTP 요청 커맨드를 모니터링
    
    2. 서버 쪽에서 사용할 데이터 세션에서 사용할 포트를 클라이언트로 알려줄 때, 이 정보를 확인하고 적절한 세션 정보를 만듬. 서버의 출발지 IP와 포트는 TCP 20번으로, 클라이언트의 IP와 서버에서 알려준 포트를 도착지로 하는 세션을 만들어 세션 테이블에 올림
    
    3. 서버에서 클라이언트로 데이터 세션을 열 때, 세션 테이블에 이미 정보가 들어가 있어 정책을 확인하지 않고 패킷이 포워딩
    

방화벽에서는 FTP 액티브 모드와 같이 방화벽을 이해하지 못하는 프로토콜을 위해 다양한 ALG기능이 제공됨

ALG가 편리하고 많은 프로토콜을 지원하지만 모든 프로토콜에 대응하게 개발할 수 없어 ALG가 완벽한 해결책은 아님

최근 대부분의 애플리케이션이 이런 방화벽이나 NAT(Network Address Translation)를 고려해 개발되고 있고 STUN(Session Traversal Utilities for NAT)과 같은 홀 펀칭(Hole Punching) 기술들도 많이 발전해 오래된 프로토콜을 제외하면 ALG 기능을 사용하지 않는 추세

## 9.3.6 방화벽의 한계

상태 기반 방화벽 개발로 인해 많은 공격을 쉽게 방어할 수 있음

하지만 방화벽을 우회하는 다양한 공격이 개발되고 특히 대규모 웜 공격으로 인터넷 서비스가 마비되면서 방화벽의 한계가 명확히 드러남

SPI 엔진을 사용하는 방화벽은 네트워크 보안에서 필수 요소가 되었지만 OSI 3, 4계층에서만 동작하므로 많은 한계가 있음

ALG 기능이 일부 애플리케이션을 감지할 수 있지만 근본적으로 바이러스를 감지하거나 백도어나 인터넷 웜을 방어할 수 없음

이런 웜 공격을 막기 위해 등장한 보안 장비가 IPS

*c.f. 현대 방화벽 NGFW, UTM*

상태 기반 방화벽은 레거시 방화벽(Legacy Firewall)이라고 함

NGFW(Next Generation Firewall)와 UTM(Unified Threat Management Firewall)은 방화벽을 애플리케이션 영역까지 확장한 보안 장비

하지만 내부적으로 구현하는 방법은 다름

NGFW는 다양한 보안 장비의 기능이 논리적으로 통합되어 있음

UTM은 물리적인 여러 가지 엔진을 통합해 함께 동작하는 방식

두 장비 모두 다양한 보안 기능이 통합되어 있고 애플리케이션 계층을 포함해 보안을 제공한다는 공통점이 있음\

<br><br>

# 9.4 IPS, IDS

애플리케이션 계층에서 이루어지는 다양한 공격을 탐지, 방어하기 위해 IDS와 IPS가 개발됨

- 방화벽 검사 영역 : 3, 4계층
- IDS/IPS 검사 영역 : 3~7계층

## 9.4.1 IPS, IDS의 정의

- IDS
  
    - Intrusion Detection System(침입 탐지 시스템)의 약자
      
    - 공격자가 시스템을 해킹할 때 탐지를 목적으로 개발된 시스템
      
    - '방어'보다 '탐지'에 초점을 맞추어 개발되어 공격에 직접 개입하거나 방어하는 것이 아니라 트래픽을 복제해 검토하고 침입 여부를 판별

- IPS
  
    - Intrusion Prevention System(침입 방지 시스템)의 약자
      
    - 탐지에 초점을 맞춘 IDS와 달리 공격이 발견되면 직접 차단하는 능력을 갖춘 장비
      
    - 트래픽을 복제해 검토만 하는 것이 아니라 트래픽이 지나가는 인라인(Inline) 상에 장비를 배치


- IDS와 IPS는 적극적으로 통신에 개입해 유해 트래픽을 차단, 방어하는 것 외에도 회피 공격을 차다하기 위한 세션 이해 가능 여부, 능동적 방어를 위한 어노말리(Anomaly) 등 다양한 기능으로 구분
  
- 최근 도입된 솔루션은 대부분 IPS
  
- IPS는 호스트 기반 IPS와 네트워크 기반 IPS가 있음
  
- 일반적으로 IPS라고 부르는 시스템은 네트워크 기반 NIPS(Network based IPS)
  
- 클라우드 네트워크의 여러 가지 제약사항 때문에 클라우드 내부 네트워크에서 NIPS 배포가 어려워 HIPS(Host based IPS) 사용 빈도가 늘었지만 여러 가지 불편한 점(서비스와 리소스 공유, 장애 발생 시 장애 주체 파악의 어려움)때문에 클라우드 내부에서도 네트워크 기반 NIPS로 바뀌는 추세

## 9.4.2 IPS, IDS의 동작 방식

기본적으로 IPS는 공격 데이터베이스(Signature)를 사용한 패턴 매칭 방식으로 운영되지만 프로토콜 어노말리(Protocol Anomaly), 프로파일 어노말리(Profile Anomaly) 등의 다른 기법으로 공격을 방어

1. **패턴 매칭 방식**
   
    - 기존 공격이나 취약점을 통해 공격 방식에 대한 데이터베이스를 습득하고 그 최신 내용을 유지하다가 공격을 파악하는 기술을 패턴 방식, 시그니처(Signature) 방식, 데이터베이스 방식 방어라고 함
      
    - 이런 패턴 기반 방어가 IPS의 기능의 상당 부분을 차지하므로 IPS는 많은 공격 데이터베이스를 보유해야 하고 최신 공격 방식을 공격 데이터베이스에 최대한 신속히 반영하는 것이 매우 중요

2. **어노말리 공격 방어**
   
    - 기존 블랙리스트 기반의 방어 방식인 패턴 기반 방어의 한계 때문에 IPS에서도 화이트리스트 기반의 방어 기법이 개발되었는데 이 방법이 바로 **어노말리**
      
    - 어노말리 기법은 분명한 공격으로 파악되지 않더라도 특정 기준 이상의 행위를 이상하다고 판단하고 방어
      
    - 프로파일 어노말리(Profile Anomaly), 프로토콜 어노말리(Protocol Anomaly)로 나뉨
      
        - **프로파일 어노말리**
          
            - 프로파일 어노말리는 평소 관리자가 정해놓은 기준이나 IPS 장비가 모니터링해 정해진 기준과 다른 행위가 일어나면 공격으로 판단
              
            - 이 기능은 동적 프로파일 기능이 강화되면서 향후 DDoS 방어 장비로 진화
              
        - **프로토콜 어노말리**
          
            - 방화벽을 우회해 내부 사용자의 PC를 공격하기 위해 해커는 사용자가 웹 서버나 이메일에 악성 코드를 올려놓고 내부 사용자가 악성 코드를 내려받아 직접 실행하도록 유도
              
            - 사용자의 PC에서 실행된 악성 코드가 외부 C&C 서버와 연결되고 이 연결을 사용해 사용자 정보를 전달하고 해커의 지시에 따라 동작
              
            - 좀비 PC가 정상적으로 서비스를 요청하는 것처럼 동작하므로 일반 방화벽에서는 이런 공격에 대한 탐지와 방어가 불가능
              
            - 이런 공격을 방어하기 위해 IPS가 필요하며 IPS 기능 중 **프로토콜 어노말리 기법이 사용**
              
            - 잘 알려진 포트와 실제로 통신하는 프로토콜이 다를 때, 이것을 파악해 적절히 제어하는 기법을 프로토콜 어노말리


## 9.4.3 IPS, IDS의 한계와 극복(NGIPS)

IPS는 근본적인 문제가 있음

네트워크상에서 빠른 속도로 애플리케이션 레벨까지 확인하기 위해 **플로(Flow) 엔진**을 사용하는데,
플로 엔진은 패킷을 모아 데이터 형태로 변환해 검사하는 것이 아니라 패킷이 흘러가는 상황을 모니터링해 공격을 탐지하므로 IPS 장비를 비교적 쉽게 우회할 수 있음

IPS는 오탐이 많이 발생하므로 지속적으로 튜닝작업을 하고 관제 인력이 장비를 모니터링하고 한경에 맞는 최적화 작업을 해야함

최근 기존 IPS의 기능을 향상시켜 문제점을 해결한 **NGIPS(Next Generation IPS)** 개념의 장비가 출시

애플리케이션을 인지하거나 다양한 시스템과 연동할 수 있고 특히 APT 공격을 방어하기 위한 일부 기능이 탑재되어 있거나 다양한 외부 시스템과 연동할 수 있는 NGIPS 장비들이 많이 소개되고 있음

방화벽이 NGFW, UTM으로 발전했듯, IPS도 다양한 장비가 통합되는 추세이고 IPS 단독시장은 축소되고 있음

<br><br>

# 9.5 DDoS 방어 장비

기존 공격은 직접 공격을 통해 관리자의 권한 탈취에 포커싱

but, 방화벽의 대중화 이후의 공격은 정상적인 서비스가 불가능하도록 방해하는데 포커싱

→ **DoS(Denial of Service) 공격**

다수의 공격자를 만들어 동시에 DoS 공격을 하는 분산형 DoS인 DDoS 공격 방식으로 발전했고 이런 공격을 방어하기 위해 DDoS 전용장비 등장

## 9.5.1 DDoS 방어 장비의 정의

초기 DDoS 공격은 시스템이나 네트워크 장비의 취약점이 타깃인 경우가 많음

단순한 DDoS 형태의 공격들도 다양한 기존 장비를 보완하는 기능이 나오고, 취약점을 노린 DDoS 공격도 제조업체들의 보안 패치 대응으로 큰 효과를 발휘하지 못해 다양한 DDoS 공격 형태가 등장

이렇게 다양한 DDoS 공격을 방어하기 위해 전문적인 장비의 필요성이 대두되고 DDoS 전용 방어 장비가 나옴

DDoS 방어 장비는 볼류메트릭 공격을 방어하기 위해 트래픽 프로파일링 기법을 주로 사용하고 인터넷의 다양한 공격 정보를 수집한 데이터베이스를 활용하기도 함

## 9.5.2 DDoS 방어 장비의 동작방식

- DDoS 방어 서비스
    - 클라우드 서비스
    - 회선 사업자의 방어 서비스
    - DDoS 방어 장비를 사내에 설치하는 방법

- DDoS 공격을 탐지해 공격을 수행하는 IP 리스트를 넘겨주면 방어 장비나 ISP 내부에서 이 IP를 버리는 것이 가장 흔한 DDoS 방어 기법
- DDoS 장비가 DDoS 여부를 판별하는 방식
    - DDoS 방어 장비의 주요 차단 방법인 **프로파일링 기법**
        
        평소 데이터 흐름을 습득해 일반적인 대역폭, 세션량, 초기 접속량, 프로토콜별 사용량 등을 저장
        
        이렇게 습득한 데이터와 일치하지 않는 과도한 트래픽이 인입되면 알려주고 차단
        
        습득한 데이터는 다양한 날짜 범위와 다양한 요소를 모니터링
        
    - 일반적인 보안 장비처럼 **보안 데이터베이스 기반**으로 방어
        
        IP 평판 데이터베이스를 공유해 DDoS 공격으로 사용된 IP 기반으로 방어 여부를 결정하거나 특정 공격 패턴을 방어하는 방법
        

## 9.5.3 DDoS 공격 타입

DDoS 공격은 다양한 기법이 있지만,

일반적으로 회선 사용량을 가득 채우는 **볼류매트릭 공격(Volumetric Attack)**,

3, 4계층의 취약점과 리소스 고갈을 노리는 **프로토콜 공격(Protocol Attack)**,

애플리케이션 취약점을 주로 노리는 **애플리케이션 공격(Application Attack)**

- DDoS의 주요 공격 타입을 정리한 표
    
    
    |  | 볼류매트릭 공격 | 프로토콜 공격 | 애플리케이션 공격 |
    | ------------- | ----------------------------- | ----------------------------- | ----------------------------- |
    |    정의    | 대용량의 트래픽을 사용해 공격 대상의 대역폭을 포화시키는 공격, 간단한 증폭 기술을 사용해 생성하기 쉬움 | 3, 4계층 프로토콜 스택의 취약점을 악용해 대상을 액세스할 수 있게 만드는 공격 | 7계층 프로토콜 스택의 약점을 악용하는 공격, 가장 정교한 공격 및 식별, 완화에 가장 까다로운 공격 |
    | 장애를 일으키는 방법 | 공격에 의해 생성된 트래픽 양은 최종 자원(웹 사이트 또는 서비스)에 대한 액세스를 완전히 차단할 수 있음. 쓸모없는 패킷이 회선을 모두 차지해 정상적인 서비스 트래픽이 통과할 수 없음 | 공격 대상이나 중간 위험 리소스의 처리 용량을 모두 사용해 서비스 중단을 유발함. 일반적인 네트워크 장비나 네트워크 보안 장비를 대상으로 하는 경우가 많음. 공격 대상 장비의 CPU, 메모리 자원을 고갈시켜 정상적인 서비스가 불가능하게 함 | 대상과의 연결을 설정한 후 프로세스와 트랜잭션을 독점해 서버 자원을 소모시킴. 애플리케이션 프로토콜 자체의 취약점이나 서비스를 제공하는 플랫폼의 취약점을 악용하는 경우가 많음 |
    |    예제    | NTP 증폭, DNS 증폭, UDP 플러드(UDP Flood), TCP 플러드 | Syn 플러드, Ping of Death | HTTP 플러드, DNS 서비스 공격, Slowloris 등 |

DDoS 방어 장비는 자동 프로파일링 기법을 지원하고 사전에 정의된 공격 데이터베이스를 이용해 애플리케이션 공격 방어도 가능하지만 **DDoS 장비의 주요 방어 목표는 볼류메트릭, 프로토콜 공격**

## 9.5.4 볼류메트릭 공격

회선을 공급해주는 ISP 내부나 사용자 네트워크 최상단에 위치시켜 볼류메트릭 공격을 완화(Mitigation)해야 함

DDoS 장비는 주로 볼류메트릭 공격이나 프로토콜 공격을 방어하는 데 사용

혼자 방어할 수 없는 공격도 많으므로 회선을 공급하는 ISP와 공조해 방어할 필요가 있음

- **좀비 PC를 이용한 볼류메트릭 공격**
    
    볼류메트릭 공격은 특정 시간에 특정 타깃을 공격하는 형태로 발생
    
    이런 공격을 하려면 미리 악성 코드에 감염되어 해커가 컨트롤할 수 있는 좀비 PC를 많이 확보해두어야 함
    
    최근 수백 Gbps부터 1Tbps 이상에 이르는 엄청나게 높은 대역폭의 공격은 대부분 **증폭 공격(Amplification Attack)**으로 수행
    
    공격자가 상대적으로 적은 대역폭으로 중간 리플렉터에 패킷을 보내면 이 트래픽이 증폭되어 피해자 네트워크에 수십~수백 배의 공격 트래픽이 발생하는 공격법을 **증폭 공격**이라 함
    
    DDoS 장비 혼자서 대부분 방어가 불가능하여 ISP를 통한 방어나 Cloud DDoS 솔루션을 통해 서비스 네트워크로 트래픽이 직접 도달하지 못하도록 조치
    

- 볼류메트릭 공격 방어를 위해 클라우드 기반의 DDoS 방어 서비스도 고려해볼 수 있음
    
    클라우드 기반 서비스는 DDoS, WAF(Web Application Firewall)과 같은 별도의 보안 장비 없이도 다양한 DDoS 공격을 방어할 수 있는 장점이 있음.실제 서비스 서버 앞에서 미리 클라이언트의 요청을 받아 처리한 후 문제가 없으면 요청을 서버 쪽으로 전달
    
    클라우드 기반 서비스의 최대 장점은 실제 서비스 네트워크가 가려지므로 네트워크 차원이나 대규모 볼류메트릭 공격도 큰 투자없이 방어할 수 있음
    
<br><br>

# 9.6 VPN

- VPN
    - Virtual Private Network의 약자
    - 물리적으로 전용선이 아닌 공중망을 이용해 논리적으로 직접 연결한 것처럼 망을 구성하는 기술
    - 논리적으로 직접 연결된 것처럼 만들어주는 통로를 터널(Tunnel)이라 하며 VPN을 이용하면 터널을 이용해 직접 연결한 것처럼 동작
    - 터널링 기법만 제공할 수 있다면 VPN이라고 할 수 있지만 터널링만 제공하는 기법은 자주 사용되지 않음
    - VPN은 주로 인터넷과 같은 공중망을 전용선과 같은 사설망처럼 사용하기 위해 도입하므로 강력한 보안을 제공해야 함
        
        → 그래서 IPSEC, SSL과 같은 암호화 기법을 제공하는 프로토콜이 VPN에 주로 사용
        

c.f. *전용 회선과 VPN*

인터넷 망이 아닌 전용 회선으로 직접 연결할 때도 전용 회선을 통해 VPN을 추가로 구성하는 경우가 있음

전용 회선은 종단 간에 직접 연결하지만 회선 자체에는 데이터가 그대로 흐르므로 암호화가 되지 않음

그래서 보안을 더 강화하기 위해 전용 회선에 VPN을 추가로 구성해 데이터를 암호화

물론 이런 데이터 암호화는 VPN 장비가 아닌 애플리케이션 단에서도 가능

## 9.6.1 VPN 동작 방식

- VPN은 가상 네트워크를 만들어주는 장비로 터널링 기법을 사용
    - 터널링 기법: 패킷을 터널링 프로토콜로 감싸 통신하는 기법
- 일반적으로 VPN이라고 부르는 프로토콜은 터널링에 보안을 위한 다양한 기술이 포함되어 있음
- 패킷을 암호화하거나 인증하거나 무결성을 체크하는 보안 기능을 이용해 인터넷에 패킷이 노출되더라도 해커나 기관들이 감청하지 못하도록 보호
- 현재 가장 많이 사용되는 보안 VPN 프로토콜은 IPSEC과 SSL

- 일반적으로 VPN은 3가지 형태로 구현
    
    **1. Host to Host 통신 보호**
    
    두 호스트 간에 직접 VPN 터널을 연동하는 기법
    
    Host to Host VPN은 VPN 구성으로 잘 사용하지 않음
    
    일반적인 VPN 장비에서 제공하는 기능은 Network to Network과 Host to Network 통신 보호 기능
    
    **2. Network to Network 통신 보호**
    
    본사-지사 같은 특정 네트워크를 가진 두 종단을 연결하는 경우
    
    IPSEC 프로토콜 스택이 가장 많이 사용
    
    **3. Host가 Network로 접근할 때 보호**
    
    모바일 사용자가 일반 인터넷망을 통해 사내망으로 연결하는 경우
    
    IPSEC과 SSL 프로토콜이 범용적으로 사용
    
- warning.or.kr을 우회하거나 직구 상품 덕분에 다양한 VPN 서비스가 사용
- 클라우드 방식으로 브라우저 익스텐션과 같은 편리한 방법으로 VPN 서비스를 제공하므로 IP 주소를 매우 쉽게 속이거나 해킹이 쉽지 않도록 패킷을 보호할 수 있음
- 이런 서비스는 단순히 사이트를 우회하는 기법으로 많이 사용되지만 카페와 같은 공중 무선망을 사용하 때, 해커의 공격을 암호화 기법으로 원천방어할 수 있어 공중 네트워크를 사용하는 경우, 이런 VPN을 보안에 활용하는 것이 좋음
- 이런 클라우드 기반의 VPN은 언급했던 데이터가 암호화되고 보호되므로 외부에서 그 패킷을 확인할 수 없다는 점을 이용한 것

c.f. *회피 공격*

- 회피 공격은 하나의 공격만 지칭하는 것이 아니라 모든 보안 장비나 보안 프로그램을 우회해 공격하는 방법
- 우회 기법은 보안 장비의 종류에 따라 달라지고 특정 회사의 특정 보안체계를 회피하기 위한 특별한 공격일 수도 있음
- 공격자가 시도한 공격이 보안 장비에서는 공격으로 판단되지 않고 정상적인 통신으로 확인되지만 실제로 그 공격이 공격 타깃인 피해자(Victim)에게 도착하는 경우, 공격으로 동작하는 모든 공격을 회피 공격이라고 함
- 회피 공격은 피해자가 패킷과 데이터를 처리하는 방법과 보안 장비의 다른 부분을 집중 공격
- 대부분의 보안 장비가 네트워크 중간에 있기 때문에 피해자와 동일한 환경과 상태에서 패킷을 점검하는 것은 불가능
- 회피 공격은 우회 공격이 가장 흔하며 집중적인 타깃이 되어온 장비는 IPS
- ATTACK이라는 단어가 들어간 공격이 있다고 가정하면 IPS에서는 공격으 탐지해 데이터베이스(Signature) 중에 ATTACK이라는 단어를 탐지하거나 차단하도록 되어 있음
- 공격자는 IPS를 우회하기 위해 ATTACK을 한번에 보내지 않고 알파벳 하나하나를 쪼개 보냄
- IPS에서는 ATTACK이라는 단어를 만드어 판단하기 어려워짐
- 최근 IPS들은 이런 형태의 공격을 방어하는 장치들을 마련해두고 있지만, 복잡한 여러 가지 우회 공격을 섞어 공격하거나 새로운 기법들도 계속 개발 중인 상황이어서 보안 장비 하나만으로 이런 공격을 더 이상 방어할 수 없음
