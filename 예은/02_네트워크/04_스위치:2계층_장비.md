# Ch04. 스위치: 2계층 장비

---

Contents

4.1 스위치 장비 동작

4.2 VLAN

4.3 STP

---

2.3.4 스위치 절에서 설명했듯이, 네트워크의 핵심 장비인 스위치는 2계층 주소인 MAC 주소를 기반으로 동작함

스위치가 MAC 주소를 기반으로 동작하는 기본적인 내용에서 깊게 들어가 스위치가 MAC 주소를 어떻게 이해하고 활용하는지 이번 장에서 살펴볼 것!

<그림4-1>

스위치는 2계층으로 통신한다

스위치는 네트워크 중간에서 패킷을 받아 필요한 곳에만 보내주는 네트워크의 중재자 역할을 함

스위치는 아무 설정 없이 네트워크에 연결해도 MAC 주소를 기반으로 패킷을 전달하는 기본 동작 수행 가능

스위치는 MAC 주소를 인식하고 패킷을 전달하는 스위치의 기본 동작 외에도 한대의 장비에서 논리적으로 네트워크를 분리할 수 있는 VLAN 기능과 네트워크의 루프를 방지하는 스패닝 트리 프로토콜(STP)과 같은 기능을 기본적으로 가지고 있음

그 외에 다양한 보안 기능과 모니터링에 필요한 여러 기능이 있지만 이 책에서는 패킷 처리를 위한 스위치의 필수 기능에 대해서만 다룸!

# 4.1  스위치 장비 동작

- 스위치의 역할
    1. 네트워크에서 통신을 중재하는 장비
    2. 여러 단말이 한꺼번에 통신 가능 → 통신하기 위해 기다리거나 충돌 떄문에 대기하는 문제 해결
    3. 네트워크의 통신 효율성 ↑ 
    4. 누가 어느 위치에 있는지 파악하고 통신이 시작되면 자신이 알고 있는 위치로 패킷을 정확히 전송
        
        스위치가 2계층 주소를 이해하고 단말의 주소인 MAC 주소와 단말이 위치하는 인터페이스 정보를 매핑한 MAC 주소 테이블을 갖고있기 때문에 가능!
        

- 스위치의 동작 방식
    
    스위치는 전송하려는 패킷의 헤더 안에 있는 2계층 목적지 주소를 확인하고 MAC 주소 테이블에서 해당 주소가 어느 포트에 있는지 확인해 해당 패킷을 그 포트로만 전송
    
    이런 역할을 수행하기 위해 스위치는 MAC 주소와 포트가 매핑된 MAC 주소 테이블이 필요함
    
    만약 테이블에 없는 도착지 주소를 가진 패킷이 스위치로 들어오면 스위치는 전체 포트로 패킷을 전송
    
    패킷의 도착지 주소가 테이블에 있으면 해당 주소가 매핑된 포트로만 전송하고, 다른 포트로는 전송 X
    
    스위치의 이런 동작 방식을 아래의 3가지로 정리할 수 있음!
    
    1. 플러딩 : Flooding
    2. 어드레스 러닝 : Address Learning
    3. 포워딩 / 필터링 : Forwarding / Filtering

## 4.1.1 Flooding

스위치는 부팅 후 네트워크 관련 정보 X → 중재의 역할 하지 못하고 허브처험 동작

허브는 패킷이 들어온 포트를 제외하고 모든 포트로 패킷을 전달한다고 한다.

스위치가 허브와 같이 모든 포트로 패킷을 흘리는 동작 방식을 **플러딩**이라 한다.

❓**그렇다면 MAC 주소 테이블에는 언제 정보가 쌓이나?**

💡 패킷이 스위치에 들어오면 해당 패킷의 MAC 주소를 보고 이를 학습해 **MAC 주소 테이블**에 저장한다.

❓ **MAC 주소를 학습한다고? 어떻게?**

💡 보다 정확한 표현은 스위치는 **MAC 주소 테이블**을 만들고 유지를 하는데 이 과정을 **Address Learning**이라고 한다.

## 4.1.2 Address Learning

스위치가 목적지 포트로 적확히 포워딩하려면 **MAC 주소 테이블**을 만들고 올바르게 유지해야 하는데 이 과정을 어드레스 러닝이라고 한다.

- 러닝 과정
    
    예시 : 출발지 MAC (AA-AA-AA), 스위치 Port : 4321
    
    1. 스위치에 *[ 출발지 MAC (AA-AA-AA), 스위치 Port : 1 ]* 정보를 가진 패킷이 들어왔다.
    2. 스위치는 MAC 주소 테이블에 출발지 MAC주소와 포트번호를 기록한다.
    3. 기록된 정보를 가지고 스위치 1번 포트에 AA-AA-AA주소를 가진 장비가 붙어 있다는 것을 습득한다.

## 4.1.3 Forwarding / Flitering

포워딩과 필터링은 스위치의 필수 기능!

패킷이 스위치에 들어온 경우 목적지 MAC를 확인할 후 MAC 주소 테이블을 통해 해당 포트로 전송하는 것을 포워딩이라고 하며, 다른 포트로는 패킷을 전송하지 않는 것을 필터링이라고 한다.

스위치에서는 이 기능을 여러 포트에서 동시에 수행 할 수 있다.

# 4.2 VLAN

네트워크 장비 중 스위치는 VLAN이라는 가상화 기술을 사용하고 있다.

하나의 물리 스위치에서 여러개의 네트워크를 나누어 사용할 수 있는 VLAN의 종류와 특징, 동작 방법에 대해 알아보자!

## 4.2.1 VLAN 이란?

- VLAN : Virtual Local Area Network
- 물리적 배치와 상관 없이 LAN을 논리적으로 분할, 구성하는 기술

- 기업과 같이 여러 부서가 함꼐 근무하며 각 부서별 네트워크를 분할할 때 네트워크를 여러개 운영
- 최근에는 전화기, 복합기, 스마트폰과 같이 PC 외에도 다수의 단말이 네트워크에 연결되므로 네트워크 분할이 더 중요하다.
- 과도한 브로드캐스트로 인한 단말들의 성능 저하, 보안 향상을 위한 차단 용도, 서비스 성격에 따른 정책 적용 등의 이유로 네트워크가 분리되어야 한다.

- VLAN을 나누면 하나의 장비를 서로 다른 네트워크를 갖도록 논리적으로 분할한 것이므로 유니캐스트 뿐만 아니라 브로드캐스트도 VLAN 간에 통신할 수 없음
- VLAN 간의 통신이 필요하다면 서로 다른 네트워크 간의 통신이므로 앞에서 배운 것 처럼 3계층 장비가 필요 (게이트웨이)

## 4.2.2 VLAN의 종류와 특징

- VLAN 할당 방식에 따른 2가지 종류
    - 포트 기반의 VLAN
        
        스위치를 논리적으로 분할해 사용하는 것이 목적인 VLAN
        
        일반적으로 언급하는 대부분의 VLAN이 해당
        
    - MAC 주소 기반의 VLAN
        
        사용자들의 자리 이동이 많아지며 개발된 VLAN
        
        스위치의 고정 포트에 VLAN을 할당하는 것이 아니라 스위치에 연결되는 단말의 MAC 주소를 기반으로 VLAN을 할당하는 기술
        
        단말이 연결되면 단말의 MAX 주소를 인식한 스위치가 해당 포트를 지정된 VLAN으로 변경
        
        단말에 따라 정보가 바뀔 수 있어 다이나믹 VLAN 이라고도 부름
        
        <그림 4-15>
        

## 4.2.3 VLAN 모드(Trunk/Access) 동작 방식

- Trunk
    
    여러개의 VLAN이 존재하는 상황에서 스위치를 서로 연결해야 하는 경우,
    
    각 VLAN끼리 통신하려면 아래 그림처럼 VLAN의 개수만큼 통신 포트를 연결해야 한다.
    
    <그림 4-19>
    
    만약 VLAN을 많이 사용하는 중.대형 네트워크인 경우 수백개의 VLAN이 있다면 수백개의 포트를 연결해야 하므로 포트 낭비 문제가 발생한다.
    
    이러한 문제를 해결하기 위해 **VLAN 태그 기능**이 나와 VLAN이 N개여도 하나의 통합 링크를 통해 패킷을 보낼 수 있게 되었고 이 방식을 **Trunking**이라고 한다.
    

- Tagging
    
    하나의 통합 링크를 통해 패킷을 보내야하므로 패킷에 VLAN 정보를 넣어 보내야 하는데 이것을 **Tagging**이라고 한다.
    
    <그림 4-20>
    
    VLAN 태그 기능은 하나의 포트에 여러 VLAN을 함께 전송할 수 있게 해주는 기능으로 이 포트를 **Tagged Port**또는 **Trunk Port**라고 한다.
    
    - **Tagged/Trunk Port** *vs* **Untagged/Access Port**
        
        Trunking 동작을 위해 존재하는 포트를 Tagged Port 또는 Trunk Port라고 하며, 그외 일반적인 포트를 Untagged Port 또는 Access Port라고 한다.
        
        Untagged/Access Port는 하나의 VLAN에만 속해있다.
        
        <그림 4-21>
        
        태그 포트로 패킷을 보낼 때는 ***VLAN ID***를 붙이고 -> 수신 측에서는 ***VLAN ID***를 제거하면서 VLAN ID의 VLAN으로 패킷을 보낼수 있다.
        

VLAN은 스위치 통신을 분할하는 기능 때문에 유니캐스트, 멀티캐스트, 브로드캐스트 모두 VLAN을 넘어가지 못함

일반적으로 VLAN이 다르다는 것은 별도의 네트워크로 분할한 것이기 때문에 네트워크가 다르고 IP 주소 할당도 다른 네트워크로 할당되는 것이 일반적임

따라서 3장에서 다룬 것 처럼 다른 네트워크와 통신이 필요 → 라우터같은 L3 장비 필요!

# 4.3 STP

SPoF(Single Point of Failure)로 인한 장애를 피하기 위해 다양한 노력을 한다.

SPoF : 하나의 시스템이나 구성 요소에서 고장이 발생했을 때 전체 시스템의 작동이 멈추는 요소

네트워크에서 이러한 문제를 해결하기 위해 이중화, 다중화된 네트워크를 디자인하고 구성한다.

네트워크를 스위치 하나로 구성하면 스위치 장애가 발생시 전체 네트워크에 영향을 미침

→ 스위치 두 대로 디자인하는 경우가 있는데 이는 패킷이 네트워크를 따라 계속 전송되므로 네트워크 루프가 발생할 수 있다.

## 4.3.1 루프

- 루프: 네트워크에 연결된 모양이 고리처럼 되돌아오는 형태로 구성된 상황
    
    네트워크 루프가 발생한다면 네트워크가 마비되고 통신이 안되는 상황이 오는데 원인 대부분이 **브로드캐스트 스톰**으로 인한 문제이다.
    
    - 브로드캐스트 스톰
        - 루프 구조로 네트워크가 연결된 상태에서 단말에서 브로드캐스트를 발생시킴
        - 스위치는 이 패킷을 패킷이 유입된 포트를 제외한 모든 포트로 플러딩
        - 플러딩 된 패킷은 다른 스위치로도 보내지고 이 패킷을 받은 스위치는 패킷이 유입된 포트를 제외한 모든 포트로 다시 플러딩
        
        위와 같이 루프 구조 에서 패킷이 계속 돌아가는데 이를 브로드캐스트 스톰이라고 한다.
        
        3 계층 헤더에는 TTL(Time to Live)라는 패킷 수명을 갖고 있지만 스위치가 확인하는 2 계층 헤더에는 이런 라이프타임 메커니즘이 없기 때문에 루프가 발생하여 패킷이 죽지않고 계속 살아남아 패킷 하나가 전체 네트워크 대역폭을 차지할 수 있다.
        
        결국 스위치와 네트워크에 연결된 단말 간 통신이 거의 불가능한 상태가 되는 것이다.
        

- 스위치 MAC 러닝 중복 문제
    
    루프 구조에서는 유니캐스트도 문제를 일으킨다. 스위치는 출발지 MAC 주소를 학습하는데 직접 전달되는 패킷과 스위치를 돌아 들어간 패킷 간의 포트가 달라 MAC 주소를 정상적으로 학습할 수 없다.
    
    MAC 주소 테이블은 하나의 MAC 주소에 대해 하나의 포트만 학습할 수 있으므로 동일한 MAC 주소가 여러 포트에서 학습되면 테이블이 반복 갱신되어 정상적으로 동작하지 않는다. 이를 MAC 어드레스 플래핑(MAC Address Flapping)이라 한다.
    
    이런 현상을 예방하기 위해 스위치 설정에 따라 경고 메시지를 관리자에게 알려주거나 수시로 일어나는 플래핑 현상을 학습하지 않도록 자동으로 조치한다.
    
    또 다른 방법 중 하나는 루프 구성 포트 중 하나의 포트만 사용하지 못하도록 셧다운 하는 방법이 있다.
    
    허나 SPoF를 예방하기 위해 다수의 스위치를 디자인했는데 다시 수동으로 셧다운 시킨다면 이는 바람직하지 않다.
    
    그래서 루프를 자동 감지해 포트를 차단하고 장애 때문에 우회로가 없을 때 차단된 포트를 스위치 스스로 다시 풀어주는 스패닝 트리 프로토콜이 개발되었다
    

## 4.3.2 STP

- STP (Spanning Tree Protocol)
    
    루프를 확인하고 적절히 포트를 사용하지 못하게 만들어 루프를 예방하는 메커니즘
    
    용어 그대로 잘 뻗은 나무처럼 뿌리부터 가지까지 루프가 생기지 않도록 유지하는 것이 목적이다.
    
    우선 첫번째로 전체 스위치가 어떻게 연결되는지 알아야 한다.
    
    이를 위해 스위치는 BPDU(Bridge Protocol Data Unit)라는 프로토콜을 통해 스위치 간에 정보를 전달하고 이렇게 수집한 정보를 이용해 전체 네트워크 트리를 만들어 루프 구간을 확인한다.
    

- 스위치 포트의 상태 및 변경과정
    
    STP는 동작 중인 스위치에서는 루프를 막기 위해 스위치 포트에 신규 스위치가 연결되면 바로 트래픽이 흐르지 않도록 차단한다. 그리고 해당 포트로 트래픽이 흘러도 되는지 확인하기 위해 BPDU를 기다려 학습하고 구조를 파악한 후 트래픽을 흘리거나 루프 구조인 경우, 차단을 유지한다.
    
    차단 상태에서 트래픽이 흐를 때까지 스위치 포트의 상태는 4가지로 구분된다.
    
    - Blocking
        - 패킷 데이터를 차단한 상태로 상대방이 보내는 BDPU를 기다린다.
        - Max Age 기간 동안 BDPU를 받지 못하거나 후순위를 받으면 리스닝 상태로 변경
        - 기본 교환 주기는 2초며 10번의 BDPU를 기다린다.
    - Listening
        - 해당 포트가 전송 상태로 변경되는 것을 결정하고 준비하는 단계
        - 자신의 BDPU 정보를 상대에게 전송
        - 총 15초 동안 대기
    - Learning
        - 포트를 포워딩하기로 결정하고 실제로 패킷 포워딩이 일어날 때 스위치가 바로 동작하도록 MAC 주소를 러닝
        - 총 15초 동안 대기
    - Forwarding
        - 패킷을 포워딩하는 단계, 정상적인 통신 가능
        
    
    기본 STP 상태 변화
    
    Blocking  —(20초)→  Listening  —(20초)→  Learning  —(15초)→  Forwarding
    
    스위치 이상 시 STP 상태 변화
    
    Blocking  —(20초)→  Listening  —(20초)→  Learning  —(15초)→  Forwarding
    
    인접 스위치 포트 이상        ↑
    
    Blocking————————| 즉시
    
- STP 동작 방식
    
    STP는 루프를 없애기 위해 나무가 뿌리에서 가지로 뻗어나가는 것처럼 토폴로지를 구성한다.
    
    토폴로지(topology) : 컴퓨터 네트워크의 요소들(링크, 노드 등)을 물리적으로 연결해 놓은 것, 또는 그 연결 방식
    
    네트워크상에서 뿌리가 되는 가장 높은 스위치를 선출하고 그 스위치를 통해 모든 BPDU가 교환되도록 하는데 그 스위치를 루트 스위치라고 부른다.
    
    모든 스위치는 처음에 자신을 루트 스위치로 인식해 동작한다. 새로운 스위치가 들어오면 서로 교환된 BPDU에 들어 있는 브릿지 ID 값을 비교한다. ID값이 더 적은 스위치를 루트로 정하고 루트로 선정된 스위치가 BPDU를 다른 스위치 쪽으로 보낸다.
    
    동작 과정은 다음과 같다.
    
    1. 하나의 루트 스위치를 선정
        - 전체 네트워크에 하나의 루트 스위치 선정
        - 자신을 대표 스위치로 적은 BPDU를 옆 스위치로 전달
    2. 루트가 아닌 스위치 중 하나의 루트 포트를 선정
        - 루트 브릿지로 가는, 경로가 가장 짧은 포트를 루트 포트라고 한다.
        - 루트 브릿지에서 보낸 BPDU를 받는 포트
    3. 하나의 세그먼트에 하나의 지정 포트를 선정
        - 스위치와 스위치가 연결되는 포트는 하나의 지정 포트를 선정
        - 스위치 간의 연결에서 이미 루트 포트로 선정된 경우, 반대쪽이 지정 포트로 선정되어 양쪽 모두 포워딩 상태
        - 스위치 간의 연결에서 아무도 루트 포트가 아닐 경우, 한쪽은 지정 포트, 다른 한쪽은 대체 포트가 되어 차단 상태
        - BPDU가 전달되는 포트

## 4.3.3 향상된 STP(RSTP, MST)

STP는 루프를 예방하기 위해 같은 네트워크에 속한 모든 스위치까지 BPDU가 전달되는 시간을 고려한다.

그러다 보니 블로킹 포트가 포워딩이 될 때까지 30~50초가 소요된다.

TCP 기반 애플리케이션에서 30초를 기다리지 못하다 보니 통신이 끊길 수 있다.

그래서 향상된 STP가 등장하였다

1. RSTP(Rapid Spanning Tree Protocol)
    
    STP는 이중화된 스위치 경로 중 정상적인 경로에 문제가 발생할 경우, 
    백업 경로를 활성화하는데 30~50초가 걸린다.
    
    이처럼 시간이 오래 걸리기 때문에 RSTP가 개발되었다.
    
    RSTP는 2~3초로 시간이 짧아 TCP 애플리케이션이 세션을 유지할 수 있게 된다.
    
    STP는 일반 토폴로지 변경과 관련된 두 가지 메시지(TCN, TCA)만 있지만 RSTP는 8개 비트를 모두 활용한다.
    
    기존 STP에서는 토폴로지가 변경되면 말단 스위치에서 루트 브릿지까지 변경 보고를 보내고 루트 브릿지가 그에 대한 연산을 다시 완료하고 이후 변경된 토폴로지 정보를 말단 스위치까지 보내는 과정에다가 네트워크에 있는 모든 스위치까지 전파되는 예비 시간까지 더하면 오래 걸리는 시간이다.
    
    하지만 RSTP는 토폴로지 변경이 일어난 스위치 자신이 모든 네트워크에 토폴로지 변경을 직접 전파할 수 있다.
    
    이로서 RSTP는 빠른 시간 내에 토폴로지 변경을 감지, 복구할 수 있어 애플리케이션 세션이 끊기지 않아 보다 안정적으로 네트워크를 운영하는데 도움이 된다.
    
    2. MST
    일반 스패닝 트리 프로토콜은 CST(Common Spanning Tree)라고 부른다. 
    
    VLAN 개수가 많더라도 한 개의 트리만 동작하게 되는데 이는 스위치의 관리 부하를 감소시키지만 루프가 생기는 토폴로지에서 한 개의 포트와 회선만 활성화되므로 자원을 효율적으로 활용할 수 없다.
    
    또한 VLAN마다 최적의 경로가 다를 수 있는데 하나의 포트만 사용하면 멀리 돌아 통신할 수도 있다.
    
    이 문제를 해결하기 위해 PVST(Per Vlan Spanning Tree)가 개발되었고,
    VLAN마다 다른 스패닝 트리 프로세스가 동작하므로 VLAN마다 별도의 경로와 트리를 만들 수 있게 되었다.
    
    허나 PVST는 모든 VLAN마다 별도의 스패닝 트리를 유지해야 하므로 많은 부담이 되었다.
    
    그래서 CST, PVST의 단점을 보완하기 위해 MST(Multiple Spanning Tree)가 개발되었다.
     
    MST는 여러 개의 VLAN을 그룹으로 묶고 그 그룹마다 별도의 스패닝 트리를 동작한다. 
    
    이 경우 PVST보다 적은 스패닝 트리 프로토콜 프로세스가 돌게 되고 로드 셰어링 기능도 함께 사용할 수 있다.
    로드 셰어링(Road Sharing) : 부하를 고루 분담시켜 한 곳에 과다하게 집중되는 것을 막는다는 일반적인 용어