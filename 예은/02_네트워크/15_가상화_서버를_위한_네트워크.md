# Ch15. 가상화 서버를 위한 네트워크

---

**Contents**

15.1 가상화 서버 구성 시의 네트워크 설정

15.2 VMware vSphere

---

# 15.1 가상화 서버 구성 시의 네트워크 설정

- VMware의 ESXi나 마이크로소프트의 Hyper-V와 같은 하이퍼 바이저를 사용하면 **하나의 물리 호스트 안에 여러 개의 가상 서버가 구동**
- 하나의 물리 호스트 내부에 있는 가상 서버가 모두 동일한 네트워크 안에서 동작할 수도 있지만 다양한 네트워크와 서비스를 **가상화 서버에 수용하기 위해 두 개 이상의 네트워크를 연결**

<img width="721" alt="NW_15-1" src="https://github.com/aivle33-dev-study/cs-study/assets/90406411/239f96a6-6a07-45d1-9458-3dad0c00a933">

가상화 서버 안에서 여러 개의 네트워크를 포함하고 있다

- VLAN은 하나의 스위치에 여러 개의 VLAN이 있을 때, 스위치 간에 모든 VLAN을 연결하려면 VLAN 만큼 케이블과 포트가 필요
- 이런 낭비를 막기 위해 **Tagged 포트 기능이 나왔고 스위치 간 연결에는 Tagged 설정을 통해 스위치에 설정된 VLAN 정보가 모두 통신하도록 설정**

- **가상화 서버는 한 개 이상의 네트워크를 갖고 있어** 일반 물리 서버를 연결할 때처럼 Untagged 설정 대신 **Tagged 설정을 함**
- 실제 가상화 서버 내에는 가상 스위치가 내장 되어 있고 가상 스위치가 스위치 역할을 해 VLAN을 Tag함

<img width="720" alt="NW_15-2" src="https://github.com/aivle33-dev-study/cs-study/assets/90406411/58e9e820-5f14-463d-992e-6ccea798c422">

가상화 서버에는 여러 개의 네트워크가 있으므로 Tagged 연결을 사용한다

- 가상 스위치 내에서 네트워크를 분리하기 위해 VLAN을 생성하고 호스트 위부에서도 해당 VLAN이 통과해야할 때는 해당 VLAN 정보를 상위 물리 스위치에서도 동일하게 설정

# 15.2 VMware vSphere

- VMware 제품인 vSphere는 가상 호스트를 중앙에서 관리하기 위한 가상화/클라우드 플랫폼
- vSphere에는 서버 가상화, 네트워크 가상화, 스토리지 가상화 등 다양한 가상화를 지원

## 15.2.1 VMware 가상 스위치

- VMware의 엔터프라이즈용 하이퍼바이저인 ESXi에서는 **서버 내부의 네트워크를 구성하기 위한 가상 스위치를 제공**

- 가상 스위치는 **논리적 소프트웨어 스위치**로 모든 기능을 제공하지는 않고 네트워크를 구성하는 데 필요한 **2계층 스위치의 기본적인 기능을 제공**
- 물론 VMware 네트워크 가상화 기술인 NSX를 사용하면 3계층 기능을 포함해 다양한 기능을 제공하짐나 VMware ESXi 호스트와 vCenter에서 제공되는 **가상 스위치는 3계층 이상의 기능을 포함하지 않음**

- 가상 스위치를 통해 ESXi 호스트 내의 가상 머신들이 외부와 통신하려면 ESXi 호스트의 물리 네트워크 카드를 물리 스위치에 연결
- 물리 스위치에 연결된 ESXi 호스트의 포트를 가상 스위치의 업링크로 지정하면 해당 가상 스위치에 연결된 가상 머신은 외부 네트워크와 통신

<img width="899" alt="NW_15-4" src="https://github.com/aivle33-dev-study/cs-study/assets/90406411/e983e0c4-7c4f-460a-85b0-5cb4a53eb5c5">

가상화 호스트 내의 스위치와 외부 스위치를 연결한다

- ESXi 호스트에는 한 개 이상의 가상 스위치를 만들 수 있음
- 가상 스위치는 두 개 이상 경로를 만들어 사용하더라도 **가상 스위치 간에 연결이 되지 않으므로 루프문제가 ESXi 호스트 내에서는 발생하지 않음**
- 그래서 스패닝 트리 프로토콜이 동작하지 않고 BPDU 패킷이 발생하지 않음

<img width="897" alt="NW_15-5" src="https://github.com/aivle33-dev-study/cs-study/assets/90406411/47e56631-6985-4293-af3c-3b81fea6078a">

가상 스위치 간에는 연결이 되지 않으므로 루프 문제가 발생하지 않는다

- 일반 물리 스위치는 각 단말이 스위치의 어느 포트에 연결되는지를 학습해 MAC 테이블로 관리 하지만 **가상 스위치는 MAC 학습작업이(Address Learning)이 필요 없음**
- 가상 머신에 할당되는 가상 네트워크 어댑터를 ESXi 하이퍼바이저가 할당하며 해당 가상 네트워크 어댑터의 물리 주소(MAC Address)를 알고 있기 때문

## 15.2.2 표준 스위치/분산 스위치

### 1. **표준 스위치**

- VMware의 가상 호스트인 ESXi의 네트워크 구성을 위해 **기본적으로 제공되는 가상 스위치**
- 표준 스위치는 ESXi 호스트마다 개별적으로 있으므로 호스트의 가상 스위치를 각각 관리
- 하나의 표준 스위치 내에서는 포트 그룹을 통해 가상 네트워크를 분리할 수 있음

<img width="898" alt="NW_15-7" src="https://github.com/aivle33-dev-study/cs-study/assets/90406411/227219f4-ac20-4463-908f-cede07e7c7c8">

표준 스위치는 호스트별로 관리

### 2. **분산 스위치**

- 분산 스위치는 가상 스위치들을 **중앙에서 일괄적으로 관리**하게 해줌
- 분산 스위치는 VMware 가상 호스트들을 중앙에서 관리 하는 vCenter가 제공하는 기능
- 분산 스위치를 사용하려면 vSphere 라이선스 중 Enterprise Plus 라이선스를 사용해야 함

- 분산 스위치에서는 호스트별로 설정하지 않고 중앙에서 네트워크 설정을 할 수 있다는 장점이 있음
- 또한, 네트워크 기능에서도 표준 스위치에서 제공하지 않는 다양한 기능을 추가로 제공

- 표준 스위치와 분산 스위치의 주요 지원 기능(556p 표참고)

- 분산 스위치는 일반 스위치와 마찬가지로 여러 개를 만들 수 있어 vCenter에서 여러 개의 분산 스위치를 생성하고 각 분산 스위치에서 관리하려는 ESXi 호스트를 추가해 동일한 네트워크 구성이 필요한 ESXi 호스트들을 그룹화해 관리할 수 있음

<img width="898" alt="NW_15-8" src="https://github.com/aivle33-dev-study/cs-study/assets/90406411/4e779d74-da6c-4f19-9a43-200be7163946">

분산 스위치는 각 호스트의 스위치를 중앙에서 관리

## 15.2.3 VMKernel 포트와 가상 시스템 포트 그룹

- 가상 스위치 내에서의 네트워크 설정 추가 시 네트워크 연결 유형은 3개
    1. VMKernel 네트워크 어댑터와 표준 스위치용 가상 시스템 포트 그룹 : 가상 스위치에서 서비스 용도를 구분할 수 있는 포트 타입에 대한 설정
    2. 하나의 물리적 네트워크 어댑터를 공유하거나 분리해 VMKernel 네트워크 어댑터와 가상 시스템 포트 그룹을 구성할 수 있음
    3. 물리적 네트워크 어댑터 : ESXi 호스트가 네트워크 스위치에 연결되는 물리 업 링크 포트에 대한 설정

### 1. **VMKernel 어댑터**

- ESXi 호스트 초기 구성과 네트워크를 통해 호스트를 관리하려면 네트워크 설정을 해야 함
- 이때 네트워크 설정은 VMKernel 어댑터라는 이름으로 구성되고 Management Network라는 네트워크 레이블로 자동 생성
- VMKernel 네트워크 어댑터는 일반 가상 머신의 서비스 용도가 아니라 ESXi 호스트가 동작하는 데 필요한 관리용 서비스 네트워크 구성에 사용

- OoB망과 같이 서비스 용도가 아닌 **호스트의 관리용 서비스 네트워크이므로 VMKernel 네트워크 어댑터를 사용하는 가상 스위치를 별도로 구성해 서비스 네트워크와 관리 네트워크 트래픽을 물리적으로 분리할 것을 권고**

### 2. **포트 그룹 설정**

- 가상 머신을 네트워크에 연결하려면 일반 서버에 네트워크 카드를 설치하듯이 **가상 네트워크 어댑터를 가상 머신에 추가해야 함**
- 추가된 네트워크 어댑터는 **이 가상 머신이 어떤 네트워크에 연결할지 선택**하기 위해 **가상 스위치에서 미리 설정해놓은 네트워크 템플릿을 지정하는데 이 템플릿이 포트 그룹**

- **포트 그룹은 가상 네트워크 내에서 동일한 속성을 적용할 수 있는 템플릿이므로 동일한 포트 그룹에 속한 가상 머신들은** 네트워크 대역을 구분하는 VLAN은 물론 보안 정책 트래픽 조절 정책, 모니터링 정책, 이중화 구성을 위한 팀 구성, 페일오버 정책등의 **동일한 적용을 받음**

## 15.2.4 포트 그룹 관리

### 1. **표준 스위치의 포트 그룹**

- 표준 스위치는 ESXi 호스트별로 있으므로 표준 스위치를 관리하려면 먼저 초기 메뉴에서 **호스트 및 클러스터** 메뉴를 선택
- 오른쪽의 호스트의 탭 메뉴 중 '구성' 탭을 선택하면 해당 호스트의 스토리지, 네트워킁, 가상 시스템 등에 대한 관리 메뉴가 나옴
- 표준 스위치에 대한 관리를 위해 '네트워킹-가상 스위치' 메뉴를 선택

- 가상 서버에서 새로운 포트 그룹을 생성
    
    - **네트워킹 추가** 버튼 선택
    
- 표준 스위치용 가상 시스템 포트그룹 선택
- 이후, 포트 그룹이 속할 표준 스위치를 선택
- 다음은 네트워크 레이블과 VLAN ID를 설정
- 마지막으로 설정 정보를 확인하고 FINISH를 클릭해 새로운 포트 그룹 생성

### 2. **분산 스위치의 포트 그룹**

- vCenter에서 ESXi 호스트의 네트워크를 통합, 관리하기 위한 분산스위치는 기본적으로 생성된 것이 없어 신규 생성부터 함

- vCenter에서 호스트를 논리적으로 관리하기 위한 구조인 Datacenter에서 **새 Distributed Switch 메뉴를 선택**
- 스위치 생성을 위해 **이름을 설정**
- 위치 항목은 vCenter에서 호스트를 논리적으로 관리하기 위한 구조인 **Datacenter**

- 다음은 분산 스위치의 버전을 선택
- 분산 스위치의 설정 구성을 정함
    
    - 업링크 수나 네트워크 트래픽 제어, 분산 스위치의 기본 포트 그룹 생성 실행 여부를 설정할 수 있음
    
    - 기본 포트 그룹 생성은 기본 값이며 생성을 원하지 않으면 체크박스를 해제
    

- 마지막으로 설정정보를 확인하고 FINISH를 클릭해 분산 스위치 생성
- 생성 완료후 분산 스위치로 관리할 호스트를 추가

- 새로운 분산 포트 그룹 생성을 위해 분산 스위치에서 새 분산 포트 그룹 메뉴를 선택
- 분산 포트 그룹을 생성할 때는 먼저 분산 포트 그룹에 사용할 이름을 설정
- 이후, 해당 분산 포트 그룹에 대한 바인딩 방법이나 포트 할당, VLAN을 포함한 추가 설정을 함
- 설정한 값을 마지막으로 확인하고 완료하면 분산 포트 그룹 생성

## 15.2.5 가상 스위치의 다양한 기능

- 표준 스위치는 표준 스위치의 편집 메뉴를 선택하면 설정을 변경하는 화면을 볼 수 있음
- 편집할 수 있는 속성
    
    - 속성 메뉴 : MTU
    
    - 보안 : 비규칙모 모드, MAC 주소 변경, 위조 전송
    
    - 트래픽 조절(QoS) : 평균 대역폭, 최대 대역폭, 버스트 크기
    
    - 팀 구성 및 페일오버 : 네트워크 이중화 설정
    

- 분산 스위치에서는 표준 스위치에서 제공하는 설정 편집 외에 LACP 또는 전용 VLAN, NetFlow, 포트 미러링과 같은 고급 설정을 추가로 제공
