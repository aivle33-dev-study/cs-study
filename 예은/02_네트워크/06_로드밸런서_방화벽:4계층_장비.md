# Ch06. 로드 밸런서 / 방화벽 : 4계층 장비 (세션 장비)

---

Contents

6.1 4계층 장비의 특징

6.2 로드 밸런서

6.3 방화벽

6.4 4계층 장비를 통과할 때의 유의점(세션관리)

---

4계층 장비에 대해서 알아보기 위해서는 **포트번호, 시퀀스번호, ACK번호**에 대한 이해가 필요합니다.

4계층 장비는 기존 2~3계층 장비에서 고려하지 않았던 **통신 방향성이나 순서**와 같은 통신 전반에 대한 관리가 필요합니다.

또한 이러한 정보를 **세션 테이블** 이라는 공간에 담아서 관리합니다.

# 6.1 4계층 장비의 특징

- 4계층 장비는 TCP와 같은 4계층 헤더에 있는 정보를 기반으로 동작
- 세션 테이블 안에서 세션 정보를 관리
    
    → 4계층에 속하는 장비들을 **세션장비**라 칭합니다.
    
- 로드밸런서, 방화벽 같은 장비가 속함
- 세션장비를 사용시 고려할 부분
    1. **세션 테이블**
        - 세션 장비는 세션 테이블 기반으로 운영된다.
        - 세션 정보를 저장, 확인하는 작업 전반을 이해해야 한다.
        - 세션 정보는 세션 테이블에 남아 있는 라이프타임이 존재한다.
    2. **Symmetric(대칭)경로 요구**
        - Inbound와 Outbound 경로가 일치해야 한다.
    3. **정보 변경(로드 밸런서의 경우)**
        - IP주소가 변경되며 확장된 1.7 로드 밸런서(ADC)는 애플리케이션 프로토콜 정보도 변경된다.

이밖에도 세션 장비의 여러 요소가 서비스에  영향을 미치기 때문에 네트워크 중간 위치에 세션을 기반으로 동작하는 방화벽, NAT, 로드밸런서와 같은 방비가 있다면 네트워크 인프라 뿐 아니라 시스템 설계와 애플리케이션 개발에도 세션 장비 고려가 필요하다.

# 6.2 로드 밸런서

- **로드밸런서**
    
    : **서버나 장비의 부하를 분산하기 위해 사용하는 장비**
    
    4계층 이상에서 동작하면서 트래픽을 분산해주며 IP주소, 4계층 정보, 애플리케이션 정보를 확인 및 수정해주는 기능이 있다. 그래서 가장 많이 쓰이는 곳이 웹 서버 부하 분산이다.
    
    사용자 천 명의 요청을 받는 서버보다 사용자 5천명의 요청을 받는 서버는 단순하게 5배가 비싼게아니라 그보다 훨씬 비싸다. 이처럼 하나의 장비를 내부 부품을 이중화 하거나 용량을 큰 부품을 사용하는것은 비용이 기하급수적으로 높아지기때문에  작은 장비를 여러대를 묶어 사용하는 방법을 선호하는데 이를 스케일아웃(Scale-Out)이라 한다.
    
    하지만, 작은 시스템이 몇대가 묶여있든 사용자는 그 사실을 알 필요도 없고 하나의 서비스로 보여야만한다. 로드 밸런서는 서비스에 사용될 대표 IP주소를 서비스 IP로 갖고 그 밑에 시스템이 늘어나면 로드밸런서가 각 시스템의 실제 IP로 변경해 요청을 보낸다.
    
    이러한 로드밸런서는 웹이나 애플리케이션 뿐아니라 FWLB(FireWall Load Bancing: 방화벽 로드밸런싱), VPNLB(VPN Load Balancing: VPN 로드 밸런싱)와 같이 다양한 서비스를 위해 사용될 수 있다.
    
    이런 로드밸런서는 동작하는 계층에 따라 다음과 같이 4계층과 7계층으로 나뉜다.
    

- ****L4 로드 밸런싱****
    - 일반적인 로드밸런서가 동작하는 방식
    - TCP, UDP 정보(특히 포트 정보)를 기반으로 로드 밸런싱을 수행한다.
    - 최근의 로드 밸런서는 L4, L7의 기능을 모두 지원하기에 L4 로드 밸런싱만 제공하는 전용장비는 찾기 힘들지만, 장비에서 L7 지원 여부와 상관없이 4계층에 대한 정보로만 분산 처리하는 경우를 L4로드 밸런싱이라 한다.
    - 즉, L4만 지원하던 L4, L7를 모두 지원하는 로드밸런서든 4계층에 대한 정보로 분산처리가 가능하면 L4 로드 밸런싱이라 할 수 있다.
- ****L7 로드 밸런싱****
    - HTTP, FTP, SMTP와 같은 애플리케이션 프로토콜 정보를 기반으로 로드 밸런싱을 수행한다.
    - HTTP 헤더 정보나 URI와 같은 정보를 기반으로 프로토콜을 이해한 뒤에 부하를 분산할 수 있다.
    - 일반적으로 이런 장비를 ADC(Application Delivery Controller)라 부르며 프록시(Proxy)역할을 수행함
    스퀴드(Squid)나 Nginx에서 수행하는 리버스 프록시(Reverse Proxy)와 유사한 기능을 갖고 있다.

## 6.2.1 L4 스위치

- 용어 그대로 4계층에서 동작하면서 로드 밸런서 기능이 있는 스위치
- 내부 동작 방식은 4계층 로드밸런서지만 외형은 스위치처럼 여러 포트를 가지고 있다
- 다양한 네트워크 구성이 가능한 스위치형 로드 밸런서가 가장 대중화되어있다.
- 부하 분산, 성능 최적화, 리다이렉션 기능을 제공
    
    <그림 6-2>
    

L4스위치가 동작하려면 다음 4가지를 설정해야 한다.

1. **가상 서버(Virtual Server)** : 사용자가 바라보는 실제 서비스
2. **가상 IP(Virtual IP)** : 사용자가 접근해야 하는 서비스 IP 주소
3. **리얼 서버(Real Server)** : 실제 서비스를 수행하는 서버
4. **리얼 IP(Real IP)** : 실제 서버의 IP

사용자는 L4스위치의 가상 IP를 목적지로 서비스를 요청하고 L4스위치가 목적지로 설정된 가상 IP를 리얼 IP로 다시 변경해 보내준다. 이 과정에서 부하를 어떤 방식으로 분산할지 결정할 수 있다.

## 6.2.2 ****ADC(Application Delivery Controller)****

- ADC(Application Delivery Controller)는 애플리케이션 계층에서 동작하는 로드 밸런서다.
- 애플리케이션 프로토콜의 헤더와 내용을 이해하고 동작한다.
    
    → 부하 분산, 정보 수정, 정보 필터링이 가능하다.
    
- ADC는 이런 동작을 위해 프록시로 동작한다.
- 대부분의 ADC는 L4스위치의 기능을 포함하고 있다.
- 대부분의 ADC는 4계층에서 애플리케이션 계층까지 다음과 같은 기능을 제공 및 수행한다.
    
    → 로드 밸런싱 기능
    
    → 페일 오버(Failover, 장애극복 기능)
    
    → 리다이렉션(Redirection)
    
- 애플리케이션 프로토콜을 이해하고 최적화 기능도 제공한다.
    
    → 캐싱(Caching), 압축(Compression), 콘텐츠 변환 및 재작성, 인코딩 변환
    
- 플러그인 형태로 보안 강화기능을 추가로 제공해서 다음과같은 기능을 제공한다.
    
    → WAF(Web Application Firewall) 기능
    
    → HTML, XML 검증및 변환 수행
    

## 6.2.3 ****L4 스위치 vs ADC****


1. L4 스위치

<그림 6-3>

- 4계층에서 동작하며 TCP, UDP 정보를 기반으로 부하를 분산한다.
- TCP 계층에서의 최적화, 보안기능도 함께 제공한다.
- TCP레벨의 Dos(Denial of Service)공격을 방어할 수 있다.
- 서버 부하를 줄이기 위해 TCP 세션 재사용과 같이 보안과 성능을 높여주는 기능도 제공할 수 있다.

1. ADC
    
    <그림 6-4>
    
- 어플리케이션을 이해하고 어플리케이션 내용에 대한 **분산, 리다이랙션, 최적화**를 제공
    
    → L4 스위치보다 다양한 기능을 사용 가능
    
- 성능 최적화를 위해 서버에서 수행하는 작업 중 **부하가 많이 걸리는 작업을 별도로 수행**
    
    그 중 하나가 이미지나 정적 컨텐츠 캐싱 기능
    
- 최근 SSL 프로토콜을 사용하는 비중이 늘면서 웹 서버의 SSL 암복호화 부하가 늘고 있음
- ADC에서는 SSL의 엔드포인트로 동작해 **클라이언트에서 ADC까지의 구간을 SSL로 처리**해주고, **ADC와 웹서버 사이를 일반 HTTP를 이용해 통신**하기도 함

### cf. 스케일 업과 스케일 아웃

서비스를 운영하다보면 데이터 양이 늘어 기존의 서버 하나로는 서비스가 불가능해지는 시점이 다가옵니다.
이때 서비스를 확장하는 방법은 스케일 업과 스케일 아웃 방식이 있습니다.

스케일 업은 해당 **장비의 스팩을 높히**는 것입니다. 메모리를 추가로 장착하거나, 기존의 자원을 새로운 고스팩 자원으로 교체하는 것을 의미합니다. 이에 반대는 스케일 다운이라 합니다.

스케일 아웃은 **시스템을 여러대 배치**하여 하나의 서비스처럼 사용하는 것을 의미합니다. 스케일 아웃 하기 위해서는 새로운 시스템 설계를 하거나, 분산을 위한 별도의 프로세스를 운영하기도하며, 로드밸런서와 같은 부하를 분산해주는 별도의 외부 시스템이 필요합니다.

# 6.3 방화벽

방화벽은 네트워크 중간에서 해당 장비를 통과하는 트래픽을 사전에 주어진 **정책 조건**에 맞춰 **혀용하거나 차단**하는 장비입니다.

<그림 6-10>

방화벽은 NAT동작 방식과 유사하게 세션정보를 장비 내부에 저장합니다. 패킷이 외부로 나갈때 세션 정보를 저장하고 패킷이 들어오거나 나갈 때 저장했떤 세선정보를 먼저 참조해 들어오는 패킷이 외부에서 처음 시작된 것인지, 내부 사용자가 외부로 요청한 응답인지 가려냅니다.

<그림 6-11>

방화벽의 세션테이블을 이용해 패킷의 인과 관계를 파악할 수 있어 정책을 간단히 유지할 수 있습니다.

만약 세션 테이블이 없다면 상태정보를 담아두는 공간이 없어 세션의 방향성을 파악하지 못하게 되고, 이에 따라서 많은 정책을 복잡하게 관리해야 합니다. 인터넷 같은 불특정 다수와 통신해야 할 때는 정책의 복잡도가 많이 증가하게 됩니다. 방화벽은 메모리에 남은 이런 상태와 세션정보를 이용해 패킷을 상세히 로깅하고 관찰할 수 있습니다.

# 6.4 4계층 장비를 통과할 때의 유의점(세션관리)

세션 장비는 2~3계층 네트워크 장비와 달리 세션을 이해하고 세션 테이블을 유지합니다. 

세션 테이블 정보를 이용해 패킷을 변경하거나 어플리케이션 성능을 최적화 하고 보안을 강화하하기 위해 패킷을 포워드하거나 드롭을 할 수 있습니다.

세션장비를 잘 사용하기 위해서는 해당 장비가 네트워크 중간에 있을 때 생기는 문제점들에 대해서 잘 파악하고 있어야 합니다.

## 6.4.1 세션 테이블 유지, 세션 정보 동기화

세션 테이블은 메모리에 저장되므로 메모리 사용률을 적절히 유지 시키기 위해서 타임 아웃 값을 가지고 있습니다. 세션 정보는 무제한으로 저장하고 있을 수 없고 여러 어플리케이션 통신을 관리하므로 일반적인 어플리케이션에 맞춰 **적당한 세션 타임아웃 값**을 유지해야 합니다.

**세션 장비의 세션 타임아웃값 보다 어플리케이션의 세션타임아웃 값이 짧으면 문제**가 생길 수 있습니다. 중간 세션장비의 세션 유지 시간이 지나 세션 테이블에 있는 정보가 사라졌는데도 양쪽 단말에서는 세션이 유지되고 있다면, 다시 통신이 시작되어 데이터를 보낼 때 중간 세션 장비에서 막히는 문제가 발생합니다. 세션장비의 **세션 테이블에 세션정보가 없는 상황**에서 SYN이 아닌 **ACK로 표시된 패킷**이 들어오면 세션 장비에서는 **비정상적인 통신**으로 판단해 패킷을 차단하게 됩니다.

<그림 6-12>

이러한 문제는 세션장비와 어플리케이션에서 각각 세션타임아웃 값에 대한 설정을 적용하는 것으로 해결할 수 있습니다.

### 1. 세션장비 운영자 입장

- 세션만료 시간 증가세션 장비 운영자가 어플리케이션에 맞게 세션만료시간을 늘리는 방법이 있씁니다. 이경우 어플리케이션 세션 유지 시간보다 방화벽 세션 유지 시간이 더 길어야합니다.
- 세션 시간은 둔 채로 중간 패킷을 수용할 수 있도록 방화벽 설정세션 테이블에 정보가 없는 ACK 패킷이 들어오면 방화벽은 패킷을 차단하지만 옵션을 조정해 **세션테이블에 없는 ACK 패킷이 들어오더라도 세션을 새로 만들어 통과**시킬 수 있는 옵션이 있습니다. 하지만 이러한 방법은 **보안을 취약하게 만들**기 때문에 여러가지 고려가 필요하고 가능하면 적용하지 않는게 좋습니다.
- 세션 장비에서 세션 타임아웃 시 양 단말에 세션 종료 통보세션 테이블 유지에 대한 문제는 양 종단의 세션 정보와 중간 세션장비의 세션정보가 일치하지 않아서 발생하는 것입니다. 그러므로 세션 상태정보를 강제로 공유하기 위해 세션 장비에서는 **세션 타임아웃 시 세션 정보를 삭제하는 것이 아닌 세션 정보에 있는 양 종단 장비에 세션 정보 만료를 통보**합니다.
    
    
    <그림 6-13>
    
    세션 만료 시의 동작 과정은 다음과 같음
    
    1. 세션 설정
    2. 일정 시간 동안 통신 없음
    3. 세션 타임아웃 값이 넘어 세션 만료
    4. 방화벽에서 양 종단 장비에 RST패킷을 전송
        - A, B 장비 통신일 경우
        - A 장비에는 출발지 B, 도착지 A인 RST 패킷을 전송
        - B 장비에는 출발지 A, 도착지 B인 RST 패킷을 전송
    5. RST 패킷을 받은 양 종단 장비는 해당 프로세스 종료
    

### 2. 개발자 입장

- 어플리케이션에서 주기적인 패킷 발생 기능 추가 어플리케이션과 세션 장비의 타임아웃 시간을 일치시키는 가장 좋은 방법은 어플리케이션에서 패킷을 주기적으로 발생시키는 것입니다. 어플리케이션이 주기적으로 **더미 패킷**을 보내게 되므로 방화벽에서는 세션 타임아웃이 발생하지 않습니다.

## 6.4.2 비대칭 경로 문제

네트워크의 안정성을 높이기 위해 네트워크 회선과 장비를 이중화합니다. 이때 패킷이 지나가는 경로는 2개 이므로 인바운드 패킷과 아웃바운드 패킷의 경로가 같거나 다를 수 있습니다. 인바운드 패킷과 아웃바운드 패킷이 같은 장비를 통과하는 것을 **대칭경로**라고 하고 다른 장비를 통과하는 것을 **비대칭 경로**라 부릅니다.

<그림 6-15>

<그림 6-16>

세션장비는 세션 테이블을 만들어 관리해야 하므로 패킷이 들어오고 나갈 때 동일한 장비를 통과해야합니다. 네트워크 경로 이중화를 위해 세션장비를 두 대 이상 설치한 경우 패킷이 들어올 때와 나갈 때 경로가 일정하게 유지되지 않으면 정상적인 서비스가 되지 않습니다.

그러므로 비대칭 경로가 생기지 않도록 네트워크 경로를 디자인하는 것이 중요합니다.

- 첫 번째 방법 : 세션테이블 동기화
    
    세션 테이블을 동기화 하면 두 개 경로상의 두 장비가 하나의 장비처럼 동작하기 때문에 비대칭 경로에서도 정상적으로 동작할 수 있습니다. 이 방식을 이용하면 패킷의 경로를 변경하지 않아도 된다는 이점이 있습니다. 하지만 패킷 응답 시간이 세션 동기화 시간보다 빠르게 되면 정상적으로 동작하지 않을 수도 있다는 단점이 있습니다. 해당 기능은 비교적 응답시간이 긴 인터넷 게이트웨이로 방화벽이 사용될 때 유용하게 사용될 수 있습니다.
    
    <그림 6-17>
    

- 두 번째 방법 : 비대칭 경로가 생길 경우 세션 장비에서 다양한 방법으로 이를 보정.
    
    인바운드 패킷이 통과하지 않았는데 아웃바운드 패킷이 장비로 들어온 경우, 인바운드 패킷을 통과한 다른 세션 장비 쪽으로 패킷을 보내 경로를 보정합니다. 그러면 강제로 대칭 경로를 만들어주게 되므로 비대칭 경로문제를 해결 하게 됩니다.
    
    <그림 6-18>
    

## 6.4.3 **하나의 통신에 두 개 이상의 세션이 사용될 때의 고려사항**

현대 프로콜은 하나의 통신을 위해 한 개의 세션만을 사용하는 경우가 대부분이지만 특별한 목적으로 두 개 이상의 세션을 만드는 경우도 있습니다. 이 때 서로 다른 두 세션이 하나의 통신을 위해 사용하고 있다는 것을 네트워크 통신 중간에 놓은 세션 장비도 파악해야 합니다.

두 통신 중 한 쪽 세션이 끊겨 있거나 세션 장비의 세션 테이블에서 삭제되면 단방향 통신만 가능하거나 통신을 하지 못할 수도 있습니다.

프로토콜은 데이터 프로토콜과 컨트롤 프로토콜로 구분할 수 있습니다.

- 데이터 프로토콜 : 데이터를 실어 나르는 프로토콜
- 컨트롤 프로토콜 : 데이터가 잘 전송되도록 세션을 제어하는 프로토콜

현대 프로토콜들은 대부분 컨트롤 프로토콜 기능과 데이터 프로토콜 기능을 하나의 프로토콜 해더나 별도의 메시지로 해결하지만 특별한 목적이 있거나 오래된 프로토콜은 두 개의 프로토콜이 분리된 경우가 있습니다.

대표적인 프로토콜이 FTP입니다.

FTP는 컨트롤 프로토콜과 데이터 프로토콜이 완전히 분리되어있고, 통신방법이 다른 두 가지 모드를 가지고 있습니다.

<그림 6-19>

FTP의 기본적인 구동방식은 Active 모드입니다. Active 모드는 명령어를 전달하는 컨트롤 프로토콜과 데이터를 전달하는 데이터 프로토콜이 분리되어 있고 방향도 반대로 동작합니다. 일반적인 클라이언트-서버 동작방식과 달리 컨트롤 프로토콜은 클라이언트에서 서버로 통신을 시작하지만 데이터 프로토콜은 서버에서 클라이언트 쪽으로 데이터를 푸쉬합니다.

<그림 6-20>

Active 모드를 사용할 경우 중간에 방화벽이나 세션 장비가 있으면 Active 모드의 동작 방식에 맞추어 방화벽의 반대 방향도 열어줘야 합니다. 특히 NAT 환경인 경우 FTP가 동작하는 프로토콜을 모두 이해할 수 있는 별도의 기능을 동작시켜야 합니다. 이러한 기능을 ALG라고 합니다.

<그림 6-21>

Passive 모드는 Active 모드의 단점을 보완하기 위해 만들어졌습니다. Active 모드의 가장 큰 문제는 컨트롤 프로토콜과 데이터 프로토콜의 방향이 반대라는 것이었습니다. Passive 모드는 컨트롤, 데이터 프로토콜이 분리되어있는 것은 같지만 클라이언트에서 서버쪽으로 데이터를 요청해 다운 받도록 동작합니다.

Passive 모드에서 클라이언트 쪽에 방화벽이나 세션 장비가 있을 경우 특별한 작업없이 동작할 수 있는 장점이 있지만 서버 쪽에 방화벽이 있으면 데이터 다운로드를 위한 추가 포트를 열어줘야 합니다. FTP 서버에서 Passive 모드에서 사용하는 데이터포트의 범위를 선정할 수 있습니다.
